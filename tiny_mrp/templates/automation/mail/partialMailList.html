<div class="card card-body app-content-body">
    <div class="app-lists">
        <ul class="list-group list-group-flush" id="mailListContainer">
      
        </ul>
    </div>
    <!-- end::app-lists -->
    <script>
        // داده‌های نمونه نامه‌های اداری
        const mailData = [
            {
                id: 1,
                number: "1402/245",
                title: "درخواست تجهیزات اداری",
                from: "واحد مالی",
                fromUnit: "واحد مالی",
                to: "واحد مدیریت",
                date: "1402/07/23",
                time: "10:30",
                status: "جدید",
                starred: false,
                avatar: null,
                avatarInitials: "م",
                avatarColor: "primary",
                hasAttachment: true,
                attachments: [
                    { name: "document1.docx", size: "2.4 MB" },
                    { name: "budget_calc.xlsx", size: "1.1 MB" }
                ],
                priority: "danger",
                priorityText: "فوری",
                excerpt: "با سلام و احترام، در خصوص درخواست تجهیزات اداری مورد نیاز واحد مالی، استدعا دارد دستور فرمایید اقدامات لازم صورت پذیرد.",
                content: `
                    <p>با سلام و احترام،</p>
                    <p>با توجه به افزایش نیروی انسانی در واحد مالی و نیاز به تجهیزات اداری جدید، استدعا دارد موارد زیر تأمین گردد:</p>
                    <ul>
                        <li>۵ عدد کامپیوتر رومیزی</li>
                        <li>۳ عدد پرینتر لیزری</li>
                        <li>۲ عدد میز کار تحریر</li>
                        <li>۵ عدد صندلی اداری</li>
                    </ul>
                    <p>برآورد هزینه‌های مربوطه در فایل پیوستی ارائه گردیده است.</p>
                    <p>لطفاً دستور فرمایید اقدامات لازم در این خصوص به عمل آید.</p>
                    <p>با تشکر</p>
                    <p><strong>مدیریت واحد مالی</strong></p>
                `,
                tag: "اداری",
                tagColor: "info",
                referrals: [
                    {
                        name: "احمد رضایی",
                        department: "واحد مالی",
                        type: "اقدام",
                        date: "1402/07/23 - 10:30",
                        status: "اقدام شده",
                        note: "بررسی و تأیید اولیه انجام شد"
                    }
                ],
                signatures: []
            },
            {
                id: 2,
                number: "1402/244",
                title: "گزارش عملکرد ماهانه واحد فناوری اطلاعات",
                from: "واحد IT",
                fromUnit: "واحد IT", 
                to: "واحد مدیریت",
                date: "1402/07/22",
                time: "14:15",
                status: "در انتظار",
                starred: true,
                avatar: null,
                avatarInitials: "آ",
                avatarColor: "info",
                hasAttachment: false,
                attachments: [],
                priority: "warning",
                priorityText: "مهم",
                excerpt: "گزارش عملکرد ماهانه واحد IT به پیوست ارسال می‌گردد. خواهشمند است بررسی و اعلام نظر فرمایید.",
                content: `
                    <p>با احترام،</p>
                    <p>گزارش عملکرد ماهانه واحد فناوری اطلاعات برای دوره یکماهه منتهی به 1402/07/20 به شرح زیر می‌باشد:</p>
                    <h6>دستاوردهای ماه:</h6>
                    <ul>
                        <li>ارتقاء سرویس ایمیل سازمانی</li>
                        <li>نصب و راه‌اندازی ۱۵ سیستم جدید</li>
                        <li>برگزاری ۲ دوره آموزش فناوری اطلاعات</li>
                        <li>پشتیبانی از ۱۲۵ درخواست کاربران</li>
                    </ul>
                    <h6>چالش‌ها:</h6>
                    <ul>
                        <li>کمبود نیروی متخصص در بخش شبکه</li>
                        <li>فرسودگی تجهیزات سرور</li>
                    </ul>
                    <p>خواهشمند است نظرات و راهنمایی‌های خود را اعلام فرمایید.</p>
                    <p>با سپاس</p>
                    <p><strong>مدیریت واحد فناوری اطلاعات</strong></p>
                `,
                tag: "فنی",
                tagColor: "success",
                referrals: [
                    {
                        name: "زهرا محمدی",
                        department: "واحد IT",
                        type: "بررسی و نظر",
                        date: "1402/07/22 - 14:15",
                        status: "در انتظار",
                        note: "در حال بررسی گزارش"
                    }
                ],
                signatures: []
            },
            {
                id: 3,
                number: "1402/243",
                title: "تایید درخواست‌های مرخصی کارکنان",
                from: "واحد منابع انسانی",
                fromUnit: "واحد منابع انسانی",
                to: "واحد مدیریت",
                date: "1402/07/21",
                time: "16:45",
                status: "امضا شده",
                starred: false,
                avatar: null,
                avatarInitials: "ن",
                avatarColor: "success",
                hasAttachment: true,
                attachments: [
                    { name: "leave_requests.docx", size: "3.2 MB" }
                ],
                priority: "success",
                priorityText: "انجام شده",
                excerpt: "لیست درخواست‌های مرخصی کارکنان برای تایید نهایی ارسال می‌گردد.",
                content: `
                    <p>با سلام،</p>
                    <p>لیست درخواست‌های مرخصی کارکنان برای ماه آینده به شرح زیر می‌باشد:</p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>نام کارمند</th>
                                <th>واحد</th>
                                <th>تاریخ مرخصی</th>
                                <th>مدت</th>
                                <th>نوع</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>علی احمدی</td>
                                <td>مالی</td>
                                <td>1402/08/05</td>
                                <td>۳ روز</td>
                                <td>استحقاقی</td>
                            </tr>
                            <tr>
                                <td>فاطمه کریمی</td>
                                <td>فروش</td>
                                <td>1402/08/12</td>
                                <td>۵ روز</td>
                                <td>استعلاجی</td>
                            </tr>
                        </tbody>
                    </table>
                    <p>لطفاً جهت تایید نهایی اقدام فرمایید.</p>
                    <p>با تشکر</p>
                    <p><strong>واحد منابع انسانی</strong></p>
                `,
                tag: "پرسنلی",
                tagColor: "warning",
                referrals: [],
                signatures: [
                    {
                        name: "علی احمدی",
                        position: "مدیر عامل",
                        date: "1402/07/21 - 16:45",
                        status: "تایید شده",
                        signature: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
                        note: "کلیه درخواست‌ها تأیید می‌گردد"
                    }
                ]
            }
        ];

        // تابع برای تولید لیست نامه‌ها
        function renderMailList() {
            const container = document.getElementById('mailListContainer');
            container.innerHTML = '';

            mailData.forEach(mail => {
                const priorityClass = getPriorityClass(mail.priority);
                const statusClass = getStatusClass(mail.status);
                const avatar = mail.avatar ? 
                    `<img src="${mail.avatar}" class="rounded-circle" alt="image">` :
                    `<span class="avatar-title bg-${mail.avatarColor}-bright text-${mail.avatarColor} rounded-circle">${mail.avatarInitials}</span>`;

                const mailItem = `
                    <li class="list-group-item ${mail.status === 'جدید' ? 'mail-unread' : ''} mail-item" data-mail-id="${mail.id}">
                        <div>
                            <div class="custom-control custom-checkbox mr-2">
                                <input type="checkbox" class="custom-control-input" id="customCheck${mail.id}">
                                <label class="custom-control-label" for="customCheck${mail.id}"></label>
                            </div>
                        </div>
                        <div>
                            <a href="#" class="add-star mr-3" title="محبوب کردن" data-id="${mail.id}">
                                <i class="fa ${mail.starred ? 'fa-star text-warning' : 'fa-star-o'} font-size-16"></i>
                            </a>
                        </div>
                        <div>
                            <figure class="avatar avatar-sm mr-3">
                                ${avatar}
                            </figure>
                        </div>
                        <div class="flex-grow-1 min-width-0">
                            <div class="mb-1 d-flex justify-content-between align-items-center">
                                <div class="text-truncate app-list-title">
                                    ${mail.title}
                                    <span class="badge bg-${mail.tagColor} badge-pill mr-1">${mail.tag}</span>
                                </div>
                                <div class="pl-3 d-flex">
                                    <span class="text-nowrap text-muted">${mail.date}</span>
                                    <div class="dropdown ml-3">
                                        <a href="#" class="btn btn-outline-light btn-sm" data-toggle="dropdown">
                                            <i class="fa fa-ellipsis-v"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-right">
                                            <a class="dropdown-item view-mail-action" href="#" data-id="${mail.id}">مشاهده</a>
                                            <a class="dropdown-item refer-mail-action" href="#" data-id="${mail.id}">ارجاع</a>
                                            <a class="dropdown-item sign-mail-action" href="#" data-id="${mail.id}">امضا</a>
                                            <div class="dropdown-divider"></div>
                                            <a class="dropdown-item text-danger" href="#">حذف</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-muted d-flex justify-content-between">
                                <div class="text-truncate small">
                                    <strong>${mail.from}</strong> → ${mail.to}: ${mail.excerpt}
                                </div>
                                <div class="text-nowrap pl-3">
                                    <ul class="list-inline">
                                        ${mail.hasAttachment ? `
                                            <li class="list-inline-item mb-0">
                                                <a href="#" data-toggle="tooltip" title="پیوست">
                                                    <i class="fa fa-paperclip"></i>
                                                </a>
                                            </li>
                                        ` : ''}
                                        <li class="list-inline-item mb-0">
                                            <i class="fa fa-circle text-${priorityClass}" data-toggle="tooltip" title="${mail.priorityText}"></i>
                                        </li>
                                        <li class="list-inline-item mb-0">
                                            <span class="badge badge-${statusClass}">${mail.status}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </li>
                `;
                container.innerHTML += mailItem;
            });

            // اضافه کردن event listeners
            addEventListeners();
        }

        // تابع برای نمایش جزئیات نامه
        function showMailDetail(mailId) {
            const mail = mailData.find(m => m.id == mailId);
            if (!mail) return;

            // پر کردن اطلاعات جزئیات
            document.getElementById('detail-title').textContent = mail.title;
            document.getElementById('detail-tag').textContent = mail.tag;
            document.getElementById('detail-tag').className = `badge bg-${mail.tagColor} badge-pill mr-1`;
            
            document.getElementById('detail-from').textContent = mail.from;
            document.getElementById('detail-number').textContent = mail.number;
            document.getElementById('detail-to').textContent = mail.to;
            document.getElementById('detail-date-time').textContent = `${mail.date} - ${mail.time}`;
            document.getElementById('detail-status').textContent = mail.status;
            document.getElementById('detail-priority').textContent = mail.priorityText;

            // آواتار
            const avatarContainer = document.getElementById('detail-avatar');
            avatarContainer.innerHTML = mail.avatar ? 
                `<img src="${mail.avatar}" class="rounded-circle" alt="image">` :
                `<span class="avatar-title bg-${mail.avatarColor}-bright text-${mail.avatarColor} rounded-circle">${mail.avatarInitials}</span>`;

            // محتوا
            document.getElementById('detail-content').innerHTML = mail.content;

            // پیوست‌ها
            const attachmentsSection = document.getElementById('attachments-section');
            const attachmentsList = document.getElementById('detail-attachments');
            if (mail.hasAttachment && mail.attachments.length > 0) {
                attachmentsList.innerHTML = '';
                mail.attachments.forEach(attachment => {
                    attachmentsList.innerHTML += `
                        <li class="small mb-2">
                            <a href="#">
                                <i data-feather="paperclip" class="mr-1 width-15 height-15"></i>
                                ${attachment.name}
                                <small class="text-muted">(${attachment.size})</small>
                            </a>
                        </li>
                    `;
                });
                attachmentsSection.style.display = 'block';
            } else {
                attachmentsSection.style.display = 'none';
            }

            // تاریخچه ارجاعات
            const referralsSection = document.getElementById('referrals-section');
            const referralsContainer = document.getElementById('detail-referrals');
            if (mail.referrals.length > 0) {
                referralsContainer.innerHTML = '';
                mail.referrals.forEach(ref => {
                    const statusClass = ref.status === 'اقدام شده' ? 'text-success' : 'text-warning';
                    referralsContainer.innerHTML += `
                        <div class="referral-history mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>${ref.name} - ${ref.department}</strong>
                                <span class="text-muted small">${ref.date}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-light text-dark">${ref.type}</span>
                                    <span class="${statusClass} mr-2">${ref.status}</span>
                                </div>
                            </div>
                            ${ref.note ? `<div class="mt-2 text-muted small">${ref.note}</div>` : ''}
                        </div>
                    `;
                });
                referralsSection.style.display = 'block';
            } else {
                referralsSection.style.display = 'none';
            }

            // امضاها
            const signaturesSection = document.getElementById('signatures-section');
            const signaturesContainer = document.getElementById('detail-signatures');
            if (mail.signatures.length > 0) {
                signaturesContainer.innerHTML = '';
                mail.signatures.forEach(sig => {
                    signaturesContainer.innerHTML += `
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="signature-display mr-3">
                                        <img src="${sig.signature}" alt="امضا" style="max-width: 120px; height: auto;">
                                    </div>
                                    <div>
                                        <strong>${sig.name}</strong>
                                        ${sig.position ? `<br><small class="text-muted">${sig.position}</small>` : ''}
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted d-block">${sig.date}</small>
                                    <span class="badge bg-success">${sig.status}</span>
                                    ${sig.note ? `<div class="mt-1 small">${sig.note}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                signaturesSection.style.display = 'block';
            } else {
                signaturesSection.style.display = 'none';
            }

            // نمایش بخش جزئیات
            document.getElementById('mailDetail').style.display = 'block';
            
            // به روزرسانی event listeners برای دکمه‌های اقدام
            updateDetailActionListeners(mailId);
        }

        // توابع کمکی
        function getPriorityClass(priority) {
            const priorityMap = {
                'danger': 'danger',
                'warning': 'warning', 
                'info': 'info',
                'success': 'success'
            };
            return priorityMap[priority] || 'info';
        }

        function getStatusClass(status) {
            const statusMap = {
                'جدید': 'primary',
                'در انتظار': 'warning',
                'خوانده شده': 'secondary',
                'امضا شده': 'success',
                'ارجاع شده': 'info'
            };
            return statusMap[status] || 'secondary';
        }

        function addEventListeners() {
            // کلیک روی آیتم نامه
            document.querySelectorAll('.mail-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (!e.target.closest('.custom-control') && !e.target.closest('.add-star') && !e.target.closest('.dropdown')) {
                        const mailId = this.getAttribute('data-mail-id');
                        showMailDetail(mailId);
                    }
                });
            });

            // مشاهده از طریق منو
            document.querySelectorAll('.view-mail-action').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const mailId = this.getAttribute('data-id');
                    showMailDetail(mailId);
                });
            });

            // بستن جزئیات
            document.getElementById('closeDetail').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('mailDetail').style.display = 'none';
            });

            // ستاره‌دار کردن
            document.querySelectorAll('.add-star').forEach(star => {
                star.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const mailId = this.getAttribute('data-id');
                    const icon = this.querySelector('i');
                    icon.classList.toggle('fa-star-o');
                    icon.classList.toggle('fa-star');
                    icon.classList.toggle('text-warning');
                });
            });
        }

        function updateDetailActionListeners(mailId) {
            // ارجاع از جزئیات
            document.querySelectorAll('.refer-mail-detail').forEach(btn => {
                btn.onclick = function() {
                    console.log('ارجاع نامه:', mailId);
                    // اینجا می‌توانید مودال ارجاع را باز کنید
                };
            });

            // امضا از جزئیات
            document.querySelectorAll('.sign-mail-detail').forEach(btn => {
                btn.onclick = function() {
                    console.log('امضای نامه:', mailId);
                    // اینجا می‌توانید مودال امضا را باز کنید
                };
            });
        }

        // اجرای اولیه
        document.addEventListener('DOMContentLoaded', function() {
            renderMailList();
            
            // Initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        });
    </script>
    <!-- begin:app-detail -->
    {% include 'automation/mail/partialMailDetail.html' %}
</div>