<script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
    if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
            var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];

            // Convert sheet to JSON to filter blank rows
            var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
            // Filter out blank rows (rows where all cells are empty, null, or undefined)
            var filteredData = jsonData.filter(row => row.some(filledCell));

            // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
            var headerRowIndex = filteredData.findIndex((row, index) =>
              row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
            );
            // Fallback
            if (headerRowIndex === -1 || headerRowIndex > 25) {
              headerRowIndex = 0;
            }

            // Convert filtered JSON back to CSV
            var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
            csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
            return csv;
        } catch (e) {
            console.error(e);
            return "";
        }
    }
    return gk_fileData[filename] || "";
    }
    </script><!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ایجاد دستور کار دستی | سیستم مدیریت نگهداری و تعمیرات</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap RTL -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    body {
        font-family: 'Tahoma', 'Arial', sans-serif;
    }
    .task-card {
        margin-bottom: 15px;
        border-right: 4px solid #0d6efd;
        border-left: none;
    }
    .task-group {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .task-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .task-item:last-child {
        border-bottom: none;
    }
    .sortable-handle {
        cursor: move;
        color: #6c757d;
    }
    .task-type-icon {
        width: 24px;
        text-align: center;
        margin-left: 8px;
        margin-right: 0;
    }
    .required-field::after {
        content: " *";
        color: red;
    }
    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
    }
    .nav-tabs .nav-link.active {
        font-weight: 600;
        border-bottom: 3px solid #0d6efd;
    }
    .tab-content {
        padding: 20px 0;
    }
    .task-type-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .task-type-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }
    .task-type-card.selected {
        border: 2px solid #0d6efd;
        background-color: #f8f9fa;
    }
    .form-text {
        text-align: right;
        font-size: 0.8rem;
    }
    .input-group > .form-control {
        border-radius: 0 0.375rem 0.375rem 0 !important;
    }
    .input-group > .btn {
        border-radius: 0.375rem 0 0 0.375rem !important;
    }
</style>
</head>
<body>
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-wrench ms-2"></i>ایجاد دستور کار دستی
                    </h3>
                </div>
                <div class="card-body">
                    <form id="workOrderForm">
                        <!-- تب‌های ناوبری -->
                        <ul class="nav nav-tabs" id="workOrderTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                    <i class="fas fa-info-circle ms-2"></i>اطلاعات پایه
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                                    <i class="fas fa-tasks ms-2"></i>وظایف مرتبط
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="instructions-tab" data-bs-toggle="tab" data-bs-target="#instructions" type="button" role="tab">
                                    <i class="fas fa-clipboard-list ms-2"></i>دستورالعمل‌ها
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="approval-tab" data-bs-toggle="tab" data-bs-target="#approval" type="button" role="tab">
                                    <i class="fas fa-check-double ms-2"></i>تأییدیه
                                </button>
                            </li>
                        </ul>

                        <!-- محتوای تب‌ها -->
                        <div class="tab-content" id="workOrderTabContent">
                            <!-- تب اطلاعات پایه -->
                            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="workOrderTitle" class="form-label required-field">عنوان دستور کار</label>
                                            <input type="text" class="form-control" id="workOrderTitle" required placeholder="مثال: روانکاری ماهانه بلبرینگ">
                                        </div>
                                        <div class="mb-3">
                                            <label for="equipmentSelect" class="form-label required-field">تجهیزات</label>
                                            <select class="form-select" id="equipmentSelect" required>
                                                <option value="">-- انتخاب تجهیزات --</option>
                                                <option value="CNC Machine #1">دستگاه CNC شماره 1</option>
                                                <option value="Hydraulic Press">پرس هیدرولیک</option>
                                                <option value="Conveyor Belt A">نوار نقاله A</option>
                                                <option value="Injection Molder">دستگاه تزریق پلاستیک</option>
                                                <option value="Packaging Machine">ماشین بسته‌بندی</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="assignedTo" class="form-label">اختصاص به</label>
                                            <select class="form-select" id="assignedTo">
                                                <option value="">-- بدون اختصاص --</option>
                                                <option value="John Smith">جان اسمیت</option>
                                                <option value="Sarah Johnson">سارا جانسون</option>
                                                <option value="Mike Brown">مایک براون</option>
                                                <option value="Lisa Wong">لیزا وانگ</option>
                                                <option value="David Miller">دیوید میلر</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="workOrderType" class="form-label required-field">نوع دستور کار</label>
                                            <select class="form-select" id="workOrderType" required>
                                                <option value="">-- انتخاب نوع --</option>
                                                <option value="Preventive">پیشگیرانه</option>
                                                <option value="Corrective">اصلاحی</option>
                                                <option value="Inspection">بازرسی</option>
                                                <option value="Breakdown">خرابی</option>
                                                <option value="Calibration">کالیبراسیون</option>
                                                <option value="Safety Check">بررسی ایمنی</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="priority" class="form-label required-field">اولویت</label>
                                            <select class="form-select" id="priority" required>
                                                <option value="">-- انتخاب اولویت --</option>
                                                <option value="High">بالا</option>
                                                <option value="Medium">متوسط</option>
                                                <option value="Low">پایین</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="dueDate" class="form-label required-field">تاریخ سررسید</label>
                                            <input type="date" class="form-control" id="dueDate" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">توضیحات</label>
                                    <textarea class="form-control" id="description" rows="2" placeholder="توضیحات مختصر درباره دستور کار..."></textarea>
                                </div>
                                <div class="d-flex justify-content-start">
                                    <button type="button" class="btn btn-primary next-tab" data-target="#tasks-tab">
                                        بعدی <i class="fas fa-arrow-left ms-2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- تب وظایف مرتبط -->
                            <div class="tab-pane fade" id="tasks" role="tabpanel">
                                <div class="mb-3">
                                    <label class="form-label required-field">نوع وظیفه</label>
                                    <div class="alert alert-info p-2 small mb-3">
                                        <i class="fas fa-info-circle ms-2"></i>
                                        تعیین کنید تکنسین‌ها چگونه این وظیفه را انجام دهند: چک باکس ساده، چک لیست یا گروه وظایف
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="card h-100 task-type-card" data-type="single">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-check-square fa-3x text-primary mb-3"></i>
                                                    <h5>وظیفه تک‌گزینه‌ای</h5>
                                                    <p class="small">تکنسین وظیفه را به صورت کامل شده علامت می‌زند</p>
                                                    <button type="button" class="btn btn-sm btn-outline-primary add-task-btn" data-type="single">
                                                        <i class="fas fa-plus ms-1"></i>افزودن وظیفه
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card h-100 task-type-card" data-type="checklist">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-list-check fa-3x text-success mb-3"></i>
                                                    <h5>چک لیست</h5>
                                                    <p class="small">تکنسین چندین آیتم چک لیست را تکمیل می‌کند</p>
                                                    <button type="button" class="btn btn-sm btn-outline-success add-task-btn" data-type="checklist">
                                                        <i class="fas fa-plus ms-1"></i>افزودن چک لیست
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card h-100 task-type-card" data-type="group">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-layer-group fa-3x text-warning mb-3"></i>
                                                    <h5>گروه وظایف</h5>
                                                    <p class="small">مجموعه‌ای از وظایف مرتبط برای تکمیل</p>
                                                    <button type="button" class="btn btn-sm btn-outline-warning add-task-btn" data-type="group">
                                                        <i class="fas fa-plus ms-1"></i>افزودن گروه
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- محفظه وظایف -->
                                <div id="tasksContainer">
                                    <!-- وظایف به صورت پویا اینجا اضافه می‌شوند -->
                                </div>
                                
                                <div class="d-flex justify-content-between mt-3">
                                    <button type="button" class="btn btn-outline-secondary prev-tab" data-target="#basic-tab">
                                        <i class="fas fa-arrow-right me-2"></i> قبلی
                                    </button>
                                    <button type="button" class="btn btn-primary next-tab" data-target="#instructions-tab">
                                        بعدی <i class="fas fa-arrow-left ms-2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- تب دستورالعمل‌ها -->
                            <div class="tab-pane fade" id="instructions" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="safetyInstructions" class="form-label">دستورالعمل‌های ایمنی</label>
                                            <textarea class="form-control" id="safetyInstructions" rows="3" placeholder="اقدامات احتیاطی ایمنی یا نیازمندی‌های PPE را لیست کنید..."></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="requiredTools" class="form-label">ابزار/قطعات مورد نیاز</label>
                                            <div id="toolsContainer">
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control tool-input" placeholder="نام ابزار/قطعه">
                                                    <button class="btn btn-outline-danger" type="button" onclick="removeTool(this)"><i class="fas fa-times"></i></button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addToolField()">
                                                <i class="fas fa-plus ms-1"></i>افزودن ابزار/قطعه
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="completionNotes" class="form-label">یادداشت‌های تکمیل</label>
                                    <textarea class="form-control" id="completionNotes" rows="2" placeholder="یادداشت‌هایی برای تکنسین‌ها پس از اتمام دستور کار..."></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-3">
                                    <button type="button" class="btn btn-outline-secondary prev-tab" data-target="#tasks-tab">
                                        <i class="fas fa-arrow-right me-2"></i> قبلی
                                    </button>
                                    <button type="button" class="btn btn-primary next-tab" data-target="#approval-tab">
                                        بعدی <i class="fas fa-arrow-left ms-2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- تب تأییدیه -->
                            <div class="tab-pane fade" id="approval" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">نیاز به تأیید</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="approvalRequired" checked>
                                                <label class="form-check-label" for="approvalRequired">نیاز به تأیید سرپرست پس از اتمام</label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="approvalRole" class="form-label">نقش تأییدکننده</label>
                                            <select class="form-select" id="approvalRole">
                                                <option value="supervisor">سرپرست نگهداری</option>
                                                <option value="manager">مدیر نگهداری</option>
                                                <option value="engineer">مهندس نگهداری</option>
                                                <option value="custom">نقش سفارشی</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="documentation" class="form-label">مستندات مورد نیاز</label>
                                            <select class="form-select" id="documentation" multiple>
                                                <option value="photos">عکس‌های قبل/بعد</option>
                                                <option value="readings">قرائت‌های تجهیزات</option>
                                                <option value="measurements">اندازه‌گیری‌ها</option>
                                                <option value="signature">امضای تکنسین</option>
                                            </select>
                                            <div class="form-text">برای انتخاب چندگانه کلید Ctrl/Cmd را نگه دارید</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary prev-tab" data-target="#instructions-tab">
                                        <i class="fas fa-arrow-right me-2"></i> قبلی
                                    </button>
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary me-2" id="saveTemplateBtn">
                                            <i class="fas fa-save me-2"></i>ذخیره به عنوان قالب
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="submitBtn">
                                            <i class="fas fa-check-circle me-2"></i>ایجاد دستور کار
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- قالب‌های وظایف (مخفی) -->
<div id="singleTaskTemplate" class="d-none">
    <div class="card task-card">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <div>
                <i class="fas fa-check-square task-type-icon"></i>
                <strong class="task-title">وظیفه تک‌گزینه‌ای</strong>
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-secondary sortable-handle ms-1">
                    <i class="fas fa-arrows-alt"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger delete-task">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label required-field">توضیحات وظیفه</label>
                <input type="text" class="form-control task-description" required placeholder="توضیح دهید تکنسین چه کاری باید انجام دهد...">
            </div>
        </div>
    </div>
</div>

<div id="checklistTaskTemplate" class="d-none">
    <div class="card task-card">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <div>
                <i class="fas fa-list-check task-type-icon"></i>
                <strong class="task-title">چک لیست</strong>
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-secondary sortable-handle ms-1">
                    <i class="fas fa-arrows-alt"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger delete-task">
                    <i class="fas fa-trash"></i>
                </div>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">عنوان چک لیست</label>
                <input type="text" class="form-control checklist-title" placeholder="مثال: مراحل بازرسی تجهیزات">
            </div>
            <div class="checklist-items">
                <div class="checklist-item input-group mb-2">
                    <input type="text" class="form-control" placeholder="توضیحات آیتم چک لیست">
                    <button class="btn btn-outline-danger" type="button" onclick="removeChecklistItem(this)"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary add-checklist-item">
                <i class="fas fa-plus ms-1"></i>افزودن آیتم
            </button>
        </div>
    </div>
</div>

<div id="taskGroupTemplate" class="d-none">
    <div class="card task-card">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <div>
                <i class="fas fa-layer-group task-type-icon"></i>
                <strong class="task-title">گروه وظایف</strong>
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-secondary sortable-handle ms-1">
                    <i class="fas fa-arrows-alt"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger delete-task">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">عنوان گروه</label>
                <input type="text" class="form-control group-title" placeholder="مثال: بررسی‌های سیستم هیدرولیک">
            </div>
            <div class="task-group-items">
                <div class="task-group-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>وظیفه 1</strong>
                        <button class="btn btn-sm btn-outline-danger" type="button" onclick="removeTaskFromGroup(this)"><i class="fas fa-times"></i></button>
                    </div>
                    <input type="text" class="form-control mb-2" placeholder="توضیحات وظیفه">
                    <select class="form-select task-type">
                        <option value="checkbox">چک باکس ساده</option>
                        <option value="checklist">چک لیست</option>
                        <option value="measurement">اندازه‌گیری</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary add-task-to-group">
                <i class="fas fa-plus ms-1"></i>افزودن وظیفه به گروه
            </button>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery UI for sortable -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- JavaScript سفارشی -->
<script>
    $(document).ready(function() {
        // Initialize Bootstrap tabs
        var workOrderTabs = new bootstrap.Tab(document.getElementById('basic-tab'));
        
        // Make tasks container sortable
        $("#tasksContainer").sortable({
            handle: ".sortable-handle",
            placeholder: "ui-state-highlight",
            update: function(event, ui) {
                updateTaskNumbers();
            }
        }).disableSelection();

        // Tab navigation buttons
        $(".next-tab").click(function() {
            var target = $(this).data("target");
            var tabTrigger = new bootstrap.Tab(document.querySelector(target));
            tabTrigger.show();
        });
        
        $(".prev-tab").click(function() {
            var target = $(this).data("target");
            var tabTrigger = new bootstrap.Tab(document.querySelector(target));
            tabTrigger.show();
        });

        // Task type card selection
        $(".task-type-card").click(function() {
            $(".task-type-card").removeClass("selected");
            $(this).addClass("selected");
            var type = $(this).data("type");
            $(this).find(".add-task-btn").trigger("click");
        });

        // Add single task
        $(document).on("click", ".add-task-btn[data-type='single']", function() {
            var taskHtml = $("#singleTaskTemplate").html();
            $("#tasksContainer").append(taskHtml);
            updateTaskNumbers();
            
            // Add delete handler
            $("#tasksContainer .delete-task").off("click").on("click", function() {
                $(this).closest(".task-card").remove();
                updateTaskNumbers();
            });
        });

        // Add checklist task
        $(document).on("click", ".add-task-btn[data-type='checklist']", function() {
            var taskHtml = $("#checklistTaskTemplate").html();
            $("#tasksContainer").append(taskHtml);
            updateTaskNumbers();
            
            // Add delete handler
            $("#tasksContainer .delete-task").off("click").on("click", function() {
                $(this).closest(".task-card").remove();
                updateTaskNumbers();
            });
            
            // Add checklist item handler
            $("#tasksContainer .add-checklist-item").off("click").on("click", function() {
                var newItem = `<div class="checklist-item input-group mb-2">
                    <input type="text" class="form-control" placeholder="توضیحات آیتم چک لیست">
                    <button class="btn btn-outline-danger" type="button" onclick="removeChecklistItem(this)"><i class="fas fa-times"></i></button>
                </div>`;
                $(this).siblings(".checklist-items").append(newItem);
            });
        });

        // Add task group
        $(document).on("click", ".add-task-btn[data-type='group']", function() {
            var taskHtml = $("#taskGroupTemplate").html();
            $("#tasksContainer").append(taskHtml);
            updateTaskNumbers();
            
            // Add delete handler
            $("#tasksContainer .delete-task").off("click").on("click", function() {
                $(this).closest(".task-card").remove();
                updateTaskNumbers();
            });
            
            // Add task to group handler
            $("#tasksContainer .add-task-to-group").off("click").on("click", function() {
                var taskCount = $(this).siblings(".task-group-items").children().length + 1;
                var newTask = `<div class="task-group-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>وظیفه ${taskCount}</strong>
                        <button class="btn btn-sm btn-outline-danger" type="button" onclick="removeTaskFromGroup(this)"><i class="fas fa-times"></i></button>
                    </div>
                    <input type="text" class="form-control mb-2" placeholder="توضیحات وظیفه">
                    <select class="form-select task-type">
                        <option value="checkbox">چک باکس ساده</option>
                        <option value="checklist">چک لیست</option>
                        <option value="measurement">اندازه‌گیری</option>
                    </select>
                </div>`;
                $(this).siblings(".task-group-items").append(newTask);
            });
        });

        // Form submission handler
        $("#workOrderForm").submit(function(e) {
            e.preventDefault();
            
            // Validate form
            if (!this.checkValidity()) {
                e.stopPropagation();
                $(this).addClass('was-validated');
                return;
            }
            
            // Collect form data
            var formData = {
                title: $("#workOrderTitle").val(),
                equipment: $("#equipmentSelect").val(),
                type: $("#workOrderType").val(),
                priority: $("#priority").val(),
                assignedTo: $("#assignedTo").val() || 'بدون اختصاص',
                dueDate: $("#dueDate").val(),
                description: $("#description").val(),
                safetyInstructions: $("#safetyInstructions").val(),
                requiredTools: [],
                completionNotes: $("#completionNotes").val(),
                approvalRequired: $("#approvalRequired").is(":checked"),
                approvalRole: $("#approvalRole").val(),
                documentation: $("#documentation").val(),
                tasks: []
            };
            
            // Collect required tools
            $(".tool-input").each(function() {
                if ($(this).val()) {
                    formData.requiredTools.push($(this).val());
                }
            });
            
            // Collect tasks
            $("#tasksContainer .task-card").each(function() {
                var task = {
                    type: $(this).find(".task-type-icon").hasClass("fa-check-square") ? "single" : 
                          $(this).find(".task-type-icon").hasClass("fa-list-check") ? "checklist" : "group",
                    title: $(this).find(".task-title").text(),
                    details: {}
                };
                
                if (task.type === "single") {
                    task.details.description = $(this).find(".task-description").val();
                } 
                else if (task.type === "checklist") {
                    task.details.title = $(this).find(".checklist-title").val();
                    task.details.items = [];
                    $(this).find(".checklist-item input").each(function() {
                        if ($(this).val()) {
                            task.details.items.push($(this).val());
                        }
                    });
                } 
                else if (task.type === "group") {
                    task.details.title = $(this).find(".group-title").val();
                    task.details.tasks = [];
                    $(this).find(".task-group-item").each(function() {
                        var groupTask = {
                            description: $(this).find("input").val(),
                            type: $(this).find(".task-type").val()
                        };
                        task.details.tasks.push(groupTask);
                    });
                }
                
                formData.tasks.push(task);
            });
            
            // For demo purposes, show alert with form data
            console.log("Work order created:", formData);
            alert("دستور کار با موفقیت ایجاد شد!\n\n" +
                  "عنوان: " + formData.title + "\n" +
                  "تجهیزات: " + formData.equipment + "\n" +
                  "نوع: " + formData.type + "\n" +
                  "اولویت: " + formData.priority + "\n" +
                  "اختصاص به: " + formData.assignedTo + "\n" +
                  "تاریخ سررسید: " + formData.dueDate + "\n" +
                  "وظایف: " + (formData.tasks.length > 0 ? formData.tasks.length + " وظیفه" : "بدون وظیفه") + "\n" +
                  "نیاز به تأیید: " + (formData.approvalRequired ? "بله" : "خیر"));
            
            // Reset form and redirect
            $("#workOrderForm")[0].reset();
            window.location.href = 'deepseek_html_20250423_9d2226.html';
        });

        // Save template button handler
        $("#saveTemplateBtn").click(function() {
            alert("دستور کار به عنوان قالب ذخیره شد!");
        });
    });

    // Helper function to update task numbers
    function updateTaskNumbers() {
        $("#tasksContainer .task-card").each(function(index) {
            $(this).find(".task-title").text(
                $(this).find(".task-type-icon").hasClass("fa-check-square") ? "وظیفه تک‌گزینه‌ای " + (index + 1) :
                $(this).find(".task-type-icon").hasClass("fa-list-check") ? "چک لیست " + (index + 1) :
                "گروه وظایف " + (index + 1)
            );
        });
    }

    // Helper function to add tool field
    function addToolField() {
        var newTool = `<div class="input-group mb-2">
            <input type="text" class="form-control tool-input" placeholder="نام ابزار/قطعه">
            <button class="btn btn-outline-danger" type="button" onclick="removeTool(this)"><i class="fas fa-times"></i></button>
        </div>`;
        $("#toolsContainer").append(newTool);
    }

    // Helper function to remove tool field
    function removeTool(button) {
        $(button).closest(".input-group").remove();
    }

    // Helper function to remove checklist item
    function removeChecklistItem(button) {
        $(button).closest(".checklist-item").remove();
    }

    // Helper function to remove task from group
    function removeTaskFromGroup(button) {
        $(button).closest(".task-group-item").remove();
        // Update task numbers in group
        $(button).closest(".task-group-items").find(".task-group-item").each(function(index) {
            $(this).find("strong").text("وظیفه " + (index + 1));
        });
    }
</script>
</body>
</html>