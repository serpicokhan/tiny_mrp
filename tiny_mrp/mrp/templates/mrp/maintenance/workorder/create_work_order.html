<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایجاد دستور کار دستی | سیستم مدیریت نگهداری و تعمیرات</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: 'Tahoma', 'Arial', sans-serif; }
        .task-card { margin-bottom: 15px; border-right: 4px solid #0d6efd; border-left: none; }
        .task-group { background-color: #f8f9fa; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        .task-item { padding: 10px; border-bottom: 1px solid #eee; }
        .task-item:last-child { border-bottom: none; }
        .sortable-handle { cursor: move; color: #6c757d; }
        .task-type-icon { width: 24px; text-align: center; margin-left: 8px; margin-right: 0; }
        .required-field::after { content: " *"; color: red; }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { font-weight: 600; border-bottom: 3px solid #0d6efd; }
        .tab-content { padding: 20px 0; }
        .task-type-card { transition: all 0.3s ease; cursor: pointer; }
        .task-type-card:hover { transform: translateY(-3px); box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); }
        .task-type-card.selected { border: 2px solid #0d6efd; background-color: #f8f9fa; }
        .form-text { text-align: right; font-size: 0.8rem; }
        .input-group > .form-control { border-radius: 0 0.375rem 0.375rem 0 !important; }
        .input-group > .btn { border-radius: 0.375rem 0 0 0.375rem !important; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-wrench ms-2"></i>ایجاد دستور کار دستی
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="workOrderForm" method="post" novalidate>
                            {% csrf_token %}
                            <ul class="nav nav-tabs" id="workOrderTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                        <i class="fas fa-info-circle ms-2"></i>اطلاعات پایه
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                                        <i class="fas fa-tasks ms-2"></i>وظایف مرتبط
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="instructions-tab" data-bs-toggle="tab" data-bs-target="#instructions" type="button" role="tab">
                                        <i class="fas fa-clipboard-list ms-2"></i>دستورالعمل‌ها
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="approval-tab" data-bs-toggle="tab" data-bs-target="#approval" type="button" role="tab">
                                        <i class="fas fa-check-double ms-2"></i>تأییدیه
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="workOrderTabContent">
                                <!-- تب اطلاعات پایه -->
                                <div class="tab-pane fade show active" id="basic" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="{{ form.title.id_for_label }}" 
                                                       name="{{ form.title.html_name }}" 
                                                       value="{{ form.title.value|default:'' }}"
                                                       {% if form.title.field.required %}required{% endif %}>
                                                {% if form.title.errors %}
                                                    <div class="invalid-feedback">{{ form.title.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ form.equipment.id_for_label }}" class="form-label">{{ form.equipment.label }}</label>
                                                <select class="form-control" 
                                                        id="{{ form.equipment.id_for_label }}" 
                                                        name="{{ form.equipment.html_name }}"
                                                        {% if form.equipment.field.required %}required{% endif %}>
                                                    {% for value, label in form.equipment.field.choices %}
                                                        <option value="{{ value }}" {% if form.equipment.value == value %}selected{% endif %}>{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% if form.equipment.errors %}
                                                    <div class="invalid-feedback">{{ form.equipment.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ form.assigned_to.id_for_label }}" class="form-label">{{ form.assigned_to.label }}</label>
                                                <select class="form-control" 
                                                        id="{{ form.assigned_to.id_for_label }}" 
                                                        name="{{ form.assigned_to.html_name }}"
                                                        {% if form.assigned_to.field.required %}required{% endif %}>
                                                    {% for value, label in form.assigned_to.field.choices %}
                                                        <option value="{{ value }}" {% if form.assigned_to.value == value %}selected{% endif %}>{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% if form.assigned_to.errors %}
                                                    <div class="invalid-feedback">{{ form.assigned_to.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.operation_type.id_for_label }}" class="form-label">{{ form.operation_type.label }}</label>
                                                <select class="form-control" 
                                                        id="{{ form.operation_type.id_for_label }}" 
                                                        name="{{ form.operation_type.html_name }}"
                                                        {% if form.operation_type.field.required %}required{% endif %}>
                                                    {% for value, label in form.operation_type.field.choices %}
                                                        <option value="{{ value }}" {% if form.operation_type.value == value %}selected{% endif %}>{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% if form.operation_type.errors %}
                                                    <div class="invalid-feedback">{{ form.operation_type.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ form.priority.id_for_label }}" class="form-label">{{ form.priority.label }}</label>
                                                <select class="form-control" 
                                                        id="{{ form.priority.id_for_label }}" 
                                                        name="{{ form.priority.html_name }}"
                                                        {% if form.priority.field.required %}required{% endif %}>
                                                    {% for value, label in form.priority.field.choices %}
                                                        <option value="{{ value }}" {% if form.priority.value == value %}selected{% endif %}>{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% if form.priority.errors %}
                                                    <div class="invalid-feedback">{{ form.priority.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ form.due_date.id_for_label }}" class="form-label">{{ form.due_date.label }}</label>
                                                <input type="date" 
                                                       class="form-control" 
                                                       id="{{ form.due_date.id_for_label }}" 
                                                       name="{{ form.due_date.html_name }}" 
                                                       value="{{ form.due_date.value|date:'Y-m-d'|default:'' }}"
                                                       {% if form.due_date.field.required %}required{% endif %}>
                                                {% if form.due_date.errors %}
                                                    <div class="invalid-feedback">{{ form.due_date.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                                        <textarea class="form-control" 
                                                  id="{{ form.description.id_for_label }}" 
                                                  name="{{ form.description.html_name }}" 
                                                  rows="3"
                                                  {% if form.description.field.required %}required{% endif %}>{{ form.description.value|default:'' }}</textarea>
                                        {% if form.description.errors %}
                                            <div class="invalid-feedback">{{ form.description.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex justify-content-start">
                                        <button type="button" class="btn btn-primary next-tab" data-target="#tasks-tab">
                                            بعدی <i class="fas fa-arrow-left ms-2"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- تب وظایف مرتبط -->
                                <div class="tab-pane fade" id="tasks" role="tabpanel">
                                    <div class="mb-3">
                                        <label class="form-label required-field">نوع وظیفه</label>
                                        <div class="alert alert-info p-2 small mb-3">
                                            <i class="fas fa-info-circle ms-2"></i>
                                            تعیین کنید تکنسین‌ها چگونه این وظیفه را انجام دهند: چک باکس ساده، چک لیست یا گروه وظایف
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <div class="card h-100 task-type-card" data-type="single">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-check-square fa-3x text-primary mb-3"></i>
                                                        <h5>وظیفه تک‌گزینه‌ای</h5>
                                                        <p class="small">تکنسین وظیفه را به صورت کامل شده علامت می‌زند</p>
                                                        <button type="button" class="btn btn-sm btn-outline-primary add-task-btn" data-type="single">
                                                            <i class="fas fa-plus ms-1"></i>افزودن وظیفه
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card h-100 task-type-card" data-type="checklist">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-list-check fa-3x text-success mb-3"></i>
                                                        <h5>چک لیست</h5>
                                                        <p class="small">تکنسین چندین آیتم چک لیست را تکمیل می‌کند</p>
                                                        <button type="button" class="btn btn-sm btn-outline-success add-task-btn" data-type="checklist">
                                                            <i class="fas fa-plus ms-1"></i>افزودن چک لیست
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card h-100 task-type-card" data-type="group">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-layer-group fa-3x text-warning mb-3"></i>
                                                        <h5>گروه وظایف</h5>
                                                        <p class="small">مجموعه‌ای از وظایف مرتبط برای تکمیل</p>
                                                        <button type="button" class="btn btn-sm btn-outline-warning add-task-btn" data-type="group">
                                                            <i class="fas fa-plus ms-1"></i>افزودن گروه
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- فرم‌ست وظایف -->
                                    <div id="tasksContainer">
                                        {{ task_formset.management_form }}
                                        {% if task_formset_formsets %}
                                            {% for task_formset_entry in task_formset_formsets %}
                                                {% with task_form=task_formset_entry.task_form checklist_formset=task_formset_entry.checklist_formset group_task_formset=task_formset_entry.group_task_formset %}
                                                    <div class="card task-card">
                                                        <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                                            <div>
                                                                <i class="fas {% if task_form.task_type.value == 'single' %}fa-check-square{% elif task_form.task_type.value == 'checklist' %}fa-list-check{% else %}fa-layer-group{% endif %} task-type-icon"></i>
                                                                <strong class="task-title">{% if task_form.task_type.value == 'single' %}وظیفه تک‌گزینه‌ای{% elif task_form.task_type.value == 'checklist' %}چک لیست{% else %}گروه وظایف{% endif %}</strong>
                                                            </div>
                                                            <div>
                                                                <button type="button" class="btn btn-sm btn-outline-secondary sortable-handle ms-1">
                                                                    <i class="fas fa-arrows-alt"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-outline-danger delete-task">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            {{ task_form.id }}
                                                            {{ task_form.task_type }}
                                                            {{ task_form.order }}
                                                            {% if task_form.task_type.value == 'single' %}
                                                                <div class="mb-3">
                                                                    <label class="form-label required-field">توضیحات وظیفه</label>
                                                                    <input type="text" 
                                                                           class="form-control" 
                                                                           id="{{ task_form.description.id_for_label }}" 
                                                                           name="{{ task_form.description.html_name }}" 
                                                                           value="{{ task_form.description.value|default:'' }}"
                                                                           {% if task_form.description.field.required %}required{% endif %}>
                                                                    {% if task_form.description.errors %}
                                                                        <div class="invalid-feedback">{{ task_form.description.errors }}</div>
                                                                    {% endif %}
                                                                </div>
                                                            {% elif task_form.task_type.value == 'checklist' %}
                                                                <div class="mb-3">
                                                                    <label class="form-label">عنوان چک لیست</label>
                                                                    <input type="text" 
                                                                           class="form-control" 
                                                                           id="{{ task_form.title.id_for_label }}" 
                                                                           name="{{ task_form.title.html_name }}" 
                                                                           value="{{ task_form.title.value|default:'' }}">
                                                                    {% if task_form.title.errors %}
                                                                        <div class="invalid-feedback">{{ task_form.title.errors }}</div>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="checklist-items">
                                                                    {% if checklist_formset %}
                                                                        {{ checklist_formset.management_form }}
                                                                        {% for checklist_form in checklist_formset %}
                                                                            <div class="checklist-item input-group mb-2">
                                                                                {{ checklist_form.id }}
                                                                                <input type="text" 
                                                                                       class="form-control" 
                                                                                       id="{{ checklist_form.description.id_for_label }}" 
                                                                                       name="{{ checklist_form.description.html_name }}" 
                                                                                       value="{{ checklist_form.description.value|default:'' }}">
                                                                                {{ checklist_form.order }}
                                                                                <button class="btn btn-outline-danger remove-checklist-item" type="button"><i class="fas fa-times"></i></button>
                                                                                {% if checklist_form.description.errors %}
                                                                                    <div class="invalid-feedback">{{ checklist_form.description.errors }}</div>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-secondary add-checklist-item">
                                                                    <i class="fas fa-plus ms-1"></i>افزودن آیتم
                                                                </button>
                                                            {% else %}
                                                                <div class="mb-3">
                                                                    <label class="form-label">عنوان گروه</label>
                                                                    <input type="text" 
                                                                           class="form-control" 
                                                                           id="{{ task_form.title.id_for_label }}" 
                                                                           name="{{ task_form.title.html_name }}" 
                                                                           value="{{ task_form.title.value|default:'' }}">
                                                                    {% if task_form.title.errors %}
                                                                        <div class="invalid-feedback">{{ task_form.title.errors }}</div>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="task-group-items">
                                                                    {% if group_task_formset %}
                                                                        {{ group_task_formset.management_form }}
                                                                        {% for group_task_form in group_task_formset %}
                                                                            <div class="task-group-item mb-3">
                                                                                {{ group_task_form.id }}
                                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                                    <strong>وظیفه {{ forloop.counter }}</strong>
                                                                                    <button class="btn btn-sm btn-outline-danger remove-task-from-group" type="button"><i class="fas fa-times"></i></button>
                                                                                </div>
                                                                                <input type="text" 
                                                                                       class="form-control mb-2" 
                                                                                       id="{{ group_task_form.description.id_for_label }}" 
                                                                                       name="{{ group_task_form.description.html_name }}" 
                                                                                       value="{{ group_task_form.description.value|default:'' }}">
                                                                                <select class="form-control" 
                                                                                        id="{{ group_task_form.subtask_type.id_for_label }}" 
                                                                                        name="{{ group_task_form.subtask_type.html_name }}">
                                                                                    {% for value, label in group_task_form.subtask_type.field.choices %}
                                                                                        <option value="{{ value }}" {% if group_task_form.subtask_type.value == value %}selected{% endif %}>{{ label }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                                {{ group_task_form.order }}
                                                                                {% if group_task_form.description.errors %}
                                                                                    <div class="invalid-feedback">{{ group_task_form.description.errors }}</div>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-secondary add-task-to-group">
                                                                    <i class="fas fa-plus ms-1"></i>افزودن وظیفه به گروه
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endwith %}
                                            {% endfor %}
                                        {% endif %}
                                    </div>

                                    <div class="d-flex justify-content-between mt-3">
                                        <button type="button" class="btn btn-outline-secondary prev-tab" data-target="#basic-tab">
                                            <i class="fas fa-arrow-right me-2"></i> قبلی
                                        </button>
                                        <button type="button" class="btn btn-primary next-tab" data-target="#instructions-tab">
                                            بعدی <i class="fas fa-arrow-left ms-2"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- تب دستورالعمل‌ها -->
                                <div class="tab-pane fade" id="instructions" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.safety_instructions.id_for_label }}" class="form-label">{{ form.safety_instructions.label }}</label>
                                                <textarea class="form-control" 
                                                          id="{{ form.safety_instructions.id_for_label }}" 
                                                          name="{{ form.safety_instructions.html_name }}" 
                                                          rows="3"
                                                          {% if form.safety_instructions.field.required %}required{% endif %}>{{ form.safety_instructions.value|default:'' }}</textarea>
                                                {% if form.safety_instructions.errors %}
                                                    <div class="invalid-feedback">{{ form.safety_instructions.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">ابزارهای مورد نیاز</label>
                                                <div id="toolsContainer">
                                                    {{ tool_formset.management_form }}
                                                    {% for tool_form in tool_formset %}
                                                        <div class="input-group mb-2">
                                                            {{ tool_form.id }}
                                                            <input type="text" 
                                                                   class="form-control" 
                                                                   id="{{ tool_form.name.id_for_label }}" 
                                                                   name="{{ tool_form.name.html_name }}" 
                                                                   value="{{ tool_form.name.value|default:'' }}"
                                                                   placeholder="نام ابزار">
                                                            <button class="btn btn-outline-danger remove-tool" type="button"><i class="fas fa-times"></i></button>
                                                            {% if tool_form.name.errors %}
                                                                <div class="invalid-feedback">{{ tool_form.name.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="addToolBtn">
                                                    <i class="fas fa-plus ms-1"></i>افزودن ابزار
                                                </button>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">قطعات یدکی مورد نیاز</label>
                                                <div id="sparePartsContainer">
                                                    {{ spare_part_formset.management_form }}
                                                    {% for spare_part_form in spare_part_formset %}
                                                        <div class="input-group mb-2">
                                                            {{ spare_part_form.id }}
                                                            <input type="text" 
                                                                   class="form-control" 
                                                                   id="{{ spare_part_form.name.id_for_label }}" 
                                                                   name="{{ spare_part_form.name.html_name }}" 
                                                                   value="{{ spare_part_form.name.value|default:'' }}"
                                                                   placeholder="نام قطعه">
                                                            <input type="text" 
                                                                   class="form-control" 
                                                                   id="{{ spare_part_form.part_code.id_for_label }}" 
                                                                   name="{{ spare_part_form.part_code.html_name }}" 
                                                                   value="{{ spare_part_form.part_code.value|default:'' }}"
                                                                   placeholder="کد قطعه">
                                                            <input type="number" 
                                                                   class="form-control" 
                                                                   id="{{ spare_part_form.quantity.id_for_label }}" 
                                                                   name="{{ spare_part_form.quantity.html_name }}" 
                                                                   value="{{ spare_part_form.quantity.value|default:'' }}"
                                                                   placeholder="تعداد" 
                                                                   min="1">
                                                            <button class="btn btn-outline-danger" type="button" onclick="removeSparePart(this)"><i class="fas fa-times"></i></button>
                                                            {% if spare_part_form.name.errors %}
                                                                <div class="invalid-feedback">{{ spare_part_form.name.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addSparePartField()">
                                                    <i class="fas fa-plus ms-1"></i>افزودن قطعه
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.completion_notes.id_for_label }}" class="form-label">{{ form.completion_notes.label }}</label>
                                        <textarea class="form-control" 
                                                  id="{{ form.completion_notes.id_for_label }}" 
                                                  name="{{ form.completion_notes.html_name }}" 
                                                  rows="3"
                                                  {% if form.completion_notes.field.required %}required{% endif %}>{{ form.completion_notes.value|default:'' }}</textarea>
                                        {% if form.completion_notes.errors %}
                                            <div class="invalid-feedback">{{ form.completion_notes.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex justify-content-between mt-3">
                                        <button type="button" class="btn btn-outline-secondary prev-tab" data-target="#tasks-tab">
                                            <i class="fas fa-arrow-right me-2"></i> قبلی
                                        </button>
                                        <button type="button" class="btn btn-primary next-tab" data-target="#approval-tab">
                                            بعدی <i class="fas fa-arrow-left ms-2"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- تب تأییدیه -->
                                <div class="tab-pane fade" id="approval" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">نیاز به تأیید</label>
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" 
                                                           class="form-check-input" 
                                                           id="{{ form.approval_required.id_for_label }}" 
                                                           name="{{ form.approval_required.html_name }}" 
                                                           {% if form.approval_required.value %}checked{% endif %}>
                                                    <label class="form-check-label" for="{{ form.approval_required.id_for_label }}">نیاز به تأیید سرپرست پس از اتمام</label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ form.approval_role.id_for_label }}" class="form-label">{{ form.approval_role.label }}</label>
                                                <select class="form-control" 
                                                        id="{{ form.approval_role.id_for_label }}" 
                                                        name="{{ form.approval_role.html_name }}"
                                                        {% if form.approval_role.field.required %}required{% endif %}>
                                                    {% for value, label in form.approval_role.field.choices %}
                                                        <option value="{{ value }}" {% if form.approval_role.value == value %}selected{% endif %}>{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                                {% if form.approval_role.errors %}
                                                    <div class="invalid-feedback">{{ form.approval_role.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.documentation.id_for_label }}" class="form-label">{{ form.documentation.label }}</label>
                                                <select class="form-control" 
                                                        id="{{ form.documentation.id_for_label }}" 
                                                        name="{{ form.documentation.html_name }}"
                                                        multiple
                                                        {% if form.documentation.field.required %}required{% endif %}>
                                                    {% for value, label in form.documentation.field.choices %}
                                                        <option value="{{ value }}" {% if value in form.documentation.value %}selected{% endif %}>{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                                <div class="form-text">برای انتخاب چندگانه کلید Ctrl/Cmd را نگه دارید</div>
                                                {% if form.documentation.errors %}
                                                    <div class="invalid-feedback">{{ form.documentation.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-4">
                                        <button type="button" class="btn btn-outline-secondary prev-tab" data-target="#instructions-tab">
                                            <i class="fas fa-arrow-right me-2"></i> قبلی
                                        </button>
                                        <div>
                                            <button type="button" class="btn btn-outline-secondary me-2" id="saveTemplateBtn">
                                                <i class="fas fa-save me-2"></i>ذخیره به عنوان قالب
                                            </button>
                                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                                <i class="fas fa-check-circle me-2"></i>ایجاد دستور کار
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- قالب‌های وظایف -->
    <div id="singleTaskTemplate" class="d-none">
        <div class="card task-card">
            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                <div>
                    <i class="fas fa-check-square task-type-icon"></i>
                    <strong class="task-title">وظیفه تک‌گزینه‌ای</strong>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary sortable-handle ms-1">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger delete-task">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label required-field">توضیحات وظیفه</label>
                    <input type="text" class="form-control task-description" required placeholder="توضیح دهید تکنسین چه کاری باید انجام دهد...">
                </div>
            </div>
        </div>
    </div>

    <div id="checklistTaskTemplate" class="d-none">
        <div class="card task-card">
            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                <div>
                    <i class="fas fa-list-check task-type-icon"></i>
                    <strong class="task-title">چک لیست</strong>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary sortable-handle ms-1">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger delete-task">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">عنوان چک لیست</label>
                    <input type="text" class="form-control checklist-title" placeholder="مثال: مراحل بازرسی تجهیزات">
                </div>
                <div class="checklist-items">
                    <div class="checklist-item input-group mb-2">
                        <input type="text" class="form-control" placeholder="توضیحات آیتم چک لیست">
                        <button class="btn btn-outline-danger" type="button" onclick="removeChecklistItem(this)"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary add-checklist-item">
                    <i class="fas fa-plus ms-1"></i>افزودن آیتم
                </button>
            </div>
        </div>
    </div>

    <div id="taskGroupTemplate" class="d-none">
        <div class="card task-card">
            <div class="card-header d-flex justify-content-between align-items-center bg-light">
                <div>
                    <i class="fas fa-layer-group task-type-icon"></i>
                    <strong class="task-title">گروه وظایف</strong>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary sortable-handle ms-1">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger delete-task">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">عنوان گروه</label>
                    <input type="text" class="form-control group-title" placeholder="مثال: بررسی‌های سیستم هیدرولیک">
                </div>
                <div class="task-group-items">
                    <div class="task-group-item mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>وظیفه 1</strong>
                            <button class="btn btn-sm btn-outline-danger" type="button" onclick="removeTaskFromGroup(this)"><i class="fas fa-times"></i></button>
                        </div>
                        <input type="text" class="form-control mb-2" placeholder="توضیحات وظیفه">
                        <select class="form-select task-type">
                            <option value="checkbox">چک باکس ساده</option>
                            <option value="checklist">چک لیست</option>
                            <option value="measurement">اندازه‌گیری</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary add-task-to-group">
                    <i class="fas fa-plus ms-1"></i>افزودن وظیفه به گروه
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script>
        $(document).ready(function() {
            $("#tasksContainer").sortable({
                handle: ".sortable-handle",
                placeholder: "ui-state-highlight",
                update: function(event, ui) {
                    updateTaskNumbers();
                }
            }).disableSelection();

            $(".next-tab").click(function() {
                var target = $(this).data("target");
                var tabTrigger = new bootstrap.Tab(document.querySelector(target));
                tabTrigger.show();
            });

            $(".prev-tab").click(function() {
                var target = $(this).data("target");
                var tabTrigger = new bootstrap.Tab(document.querySelector(target));
                tabTrigger.show();
            });

            $(".task-type-card").click(function() {
                $(".task-type-card").removeClass("selected");
                $(this).addClass("selected");
                $(this).find(".add-task-btn").trigger("click");
            });

            $(document).on("click", ".add-task-btn[data-type='single']", function() {
                var taskHtml = $("#singleTaskTemplate").html();
                $("#tasksContainer").append(taskHtml);
                updateTaskNumbers();
                $("#tasksContainer .delete-task").off("click").on("click", function() {
                    $(this).closest(".task-card").remove();
                    updateTaskNumbers();
                });
            });

            $(document).on("click", ".add-task-btn[data-type='checklist']", function() {
                var taskHtml = $("#checklistTaskTemplate").html();
                $("#tasksContainer").append(taskHtml);
                updateTaskNumbers();
                $("#tasksContainer .delete-task").off("click").on("click", function() {
                    $(this).closest(".task-card").remove();
                    updateTaskNumbers();
                });
                $("#tasksContainer .add-checklist-item").off("click").on("click", function() {
                    var newItem = `<div class="checklist-item input-group mb-2">
                        <input type="text" class="form-control" placeholder="توضیحات آیتم چک لیست">
                        <button class="btn btn-outline-danger" type="button" onclick="removeChecklistItem(this)"><i class="fas fa-times"></i></button>
                    </div>`;
                    $(this).siblings(".checklist-items").append(newItem);
                });
            });

            $(document).on("click", ".add-task-btn[data-type='group']", function() {
                var taskHtml = $("#taskGroupTemplate").html();
                $("#tasksContainer").append(taskHtml);
                updateTaskNumbers();
                $("#tasksContainer .delete-task").off("click").on("click", function() {
                    $(this).closest(".task-card").remove();
                    updateTaskNumbers();
                });
                $("#tasksContainer .add-task-to-group").off("click").on("click", function() {
                    var taskCount = $(this).siblings(".task-group-items").children().length + 1;
                    var newTask = `<div class="task-group-item mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>وظیفه ${taskCount}</strong>
                            <button class="btn btn-sm btn-outline-danger" type="button" onclick="removeTaskFromGroup(this)"><i class="fas fa-times"></i></button>
                        </div>
                        <input type="text" class="form-control mb-2" placeholder="توضیحات وظیفه">
                        <select class="form-select task-type">
                            <option value="checkbox">چک باکس ساده</option>
                            <option value="checklist">چک لیست</option>
                            <option value="measurement">اندازه‌گیری</option>
                        </select>
                    </div>`;
                    $(this).siblings(".task-group-items").append(newTask);
                });
            });

            $("#saveTemplateBtn").click(function() {
                alert("دستور کار به عنوان قالب ذخیره شد!");
            });

            function updateTaskNumbers() {
                $("#tasksContainer .task-card").each(function(index) {
                    $(this).find(".task-title").text(
                        $(this).find(".task-type-icon").hasClass("fa-check-square") ? "وظیفه تک‌گزینه‌ای " + (index + 1) :
                        $(this).find(".task-type-icon").hasClass("fa-list-check") ? "چک لیست " + (index + 1) :
                        "گروه وظایف " + (index + 1)
                    );
                });
            }
            $("#addToolBtn").click(function() {
                addToolField();
            });
            function addToolField() {
                var newTool = `<div class="input-group mb-2">
                    <input type="text" class="form-control tool-input" placeholder="نام ابزار">
                    <button class="btn btn-outline-danger" type="button" onclick="removeTool(this)"><i class="fas fa-times"></i></button>
                </div>`;
                $("#toolsContainer").append(newTool);
            }

            function removeTool(button) {
                $(button).closest(".input-group").remove();
            }

            function addSparePartField() {
                var newSparePart = `<div class="input-group mb-2">
                    <input type="text" class="form-control" placeholder="نام قطعه">
                    <input type="text" class="form-control" placeholder="کد قطعه">
                    <input type="number" class="form-control" placeholder="تعداد" min="1">
                    <button class="btn btn-outline-danger" type="button" onclick="removeSparePart(this)"><i class="fas fa-times"></i></button>
                </div>`;
                $("#sparePartsContainer").append(newSparePart);
            }

            function removeSparePart(button) {
                $(button).closest(".input-group").remove();
            }

            function removeChecklistItem(button) {
                $(button).closest(".checklist-item").remove();
            }

            function removeTaskFromGroup(button) {
                $(button).closest(".task-group-item").remove();
                $(button).closest(".task-group-items").find(".task-group-item").each(function(index) {
                    $(this).find("strong").text("وظیفه " + (index + 1));
                });
            }
        });
    </script>
</body>
</html>