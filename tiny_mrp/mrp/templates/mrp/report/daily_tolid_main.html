{% extends 'mrp/blank-page.html' %}
{% load static %}
{% block stylesheet %}
<link rel="stylesheet" href="{% static 'vendors/select2/css/select2.min.css' %}" type="text/css">

<style>
  
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .card-header {
        border-radius: 10px 10px 0 0 !important;
        font-weight: 600;
    }
    .summary-card {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color: white;
    }
    .table th {
        background-color: #f1f5f9;
    }
    .waste-rate {
        font-weight: bold;
    }
    .low-waste {
        color: #28a745;
    }
    .medium-waste {
        color: #ffc107;
    }
    .high-waste {
        color: #dc3545;
    }
   
</style>

{% endblock %}
{% block content %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-funnel"></i> فیلترهای گزارش
    </div>
    <div class="card-body">
        <form>
            <!-- Row for Filters -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="operator" class="form-label">اپراتور</label>
                    <select class="form-control operator-name" 
                            data-machine-id="{{c.machine.id}}"
                            multiple="multiple"
                            style="width: 100%;">
                        {% for i in operator_data %}
                            <option value="{{i.id}}" selected>{{i.name}}</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" class="operator-data" name="operator_data" value="{{operators_id}}" id="operator_data">
                </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">تاریخ شروع</label>
                    <input type="text" class="form-control" id="startDate" name="start_date" value="{{start_date}}">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">تاریخ پایان</label>
                    <input type="text" class="form-control" id="endDate" name="end_date" value="{{end_date}}">
                </div>
                <div class="col-md-3">
                    <label for="profile" class="form-label">پروفایل مالی</label>
                    <select class="form-control" id="profile" name="profile_id">
                        <option value="-1" selected>همه</option>
                        {% for i in profiles %}
                            <option value="{{i.id}}" {% if i.id == profile_id %} selected {% endif %}>{{i.description}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <!-- Row for Additional Filters -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="machine" class="form-label">سالن</label>
                    <select class="form-control" id="machine" name="machine_id">
                        <option value="-1" selected>همه سالن‌ها</option>
                        {% for i in makan %}
                            <option value="{{i.id}}" {% if i.id == machin_id %} selected {% endif %}>{{i.assetName}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="machinecat" class="form-label">دستگاه</label>
                    <select class="form-control" id="machinecat" name="category_id">
                        <option value="-1" selected>همه دستگاه‌ها</option>
                        {% for i in category %}
                            <option value="{{i.id}}" {% if i.id == category_id %} selected {% endif %}>{{i.name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="shift" class="form-label">شیفت</label>
                    <select class="form-control" id="shift" name="shift_id">
                        <option value="-1" selected>همه شیفت‌ها</option>
                        {% for i in shifts %}
                            <option value="{{i.id}}" {% if i.id == shift_id %} selected {% endif %}>{{i.name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="moshakhase" class="form-label">کد نخ</label>
                    <select class="form-control nakh-name" id="moshakhase"
                            data-machine-id="{{c.machine.id}}"
                            style="width: 100%;">
                            {% if code_nakh %}
                            <option value="{{code_nakh.id}}">{{code_nakh}}</option>
                            {% endif %}
                    </select>
                    <input type="hidden" class="nakh-data" name="nakh_data_" {% if code_nakh %} value={{code_nakh}} {% endif %}>
                </div>
            
            </div>
            <div class="row">
                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-group w-100">
                        <div class="custom-control custom-switch mb-3">
                            <input type="checkbox" class="custom-control-input" id="customSwitch1" name="collective" {{collective}}>
                            <label class="custom-control-label" for="customSwitch1">ایجاد گزارش به صورت تجمعی</label>
                        </div>
                       
                    </div>
                </div>
                <div class="col-md-3 justify-content-center">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-filter-circle"></i> اعمال فیلترها
                    </button>
                </div>
                <div class="col-md-3  justify-content-center">
                    <a href="{% url 'production_report_excel' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-success">
                        <i class="bi bi-file-earmark-excel"></i> خروجی اکسل
                    </a>
                </div>
            </div>
            <!-- Row for Export Button -->
            <div class="row">
               
            </div>
        </form>
    </div>
</div>

<!-- خلاصه آمار -->
<div class="row">
    <div class="col-md-4">
        <div class="card summary-card">
            <div class="card-body text-center">
                <h5 class="card-title">تعداد کل تولید</h5>
                <h2 class="card-text">0</h2>
                <p class="card-text">عدد</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card summary-card">
            <div class="card-body text-center">
                <h5 class="card-title">ضایعات کل</h5>
                <h2 class="card-text">328</h2>
                <p class="card-text">عدد</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card summary-card">
            <div class="card-body text-center">
                <h5 class="card-title">نرخ ضایعات</h5>
                <h2 class="card-text">2.55%</h2>
                <p class="card-text">از کل تولید</p>
            </div>
        </div>
    </div>
</div>

<!-- جدول گزارش -->
<div class="card mt-4">
    <div class="card-header bg-success text-white">
        <i class="bi bi-table"></i> گزارش تولید و ضایعات
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead>
                    <tr>
                        <th>تاریخ</th>
                        <th>اپراتور</th>
                        <th>تعداد op</th>
                        <th>دستگاه</th>
                        <th>کد نخ</th>
                        <th>تولید</th>
                        <th>همگن 36</th>
                        <th>تعداد ضایعات</th>
                        <th>نرخ ضایعات</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in page_obj %}
                    <tr>
                        <td>{{i.date}}</td>
                        <td>{{i.operator}}</td>
                        <td>{{i.op_count}}</td>
                        <td>{{i.machine}}</td>
                        <td>{{i.code_nakh}}</td>
                        <td>{{i.production|floatformat:0}}</td>
                        <th>{{i.eval_36_tolid|floatformat:0}}</th>
                        
                        <td>{{i.wastage}}</td>
                        <td><span class="waste-rate low-waste">{{i.wastage_rate|floatformat:0}}%</span></td>
                        <td>
                           {{i.randeman_production|floatformat:0}}
                        </td>
                    </tr>
                    {% endfor %}

                </tbody>
                <!-- <tfoot>
                    <tr class="table-active">
                        <th colspan="3">مجموع</th>
                        <th>7,250</th>
                        <th>205</th>
                        <th>2.83%</th>
                        <th></th>
                    </tr>
                </tfoot> -->
            </table>
        </div>
        
        <!-- صفحه‌بندی -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.operator_id %}&operator_id={{ request.GET.operator_id }}{% endif %}{% if request.GET.machine_id %}&machine_id={{ request.GET.machine_id }}{% endif %}{% if request.GET.category_id %}&category_id={{ request.GET.category_id }}{% endif %}{% if request.GET.operator_data %}&operator_data={{ request.GET.operator_data }}{% endif %}{% if request.GET.collective %}&collective={{ request.GET.collective }}{% endif %}{% if request.GET.moshakhase %}&moshakhase={{ request.GET.moshakhase }}{% endif %}" aria-label="Previous">
                            <span aria-hidden="true">قبلی</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" href="#" aria-label="Previous">
                            <span aria-hidden="true">قبلی</span>
                        </a>
                    </li>
                {% endif %}
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active" aria-current="page">
                            <a class="page-link" href="#">{{ num }}</a>
                        </li>
                    {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.operator_id %}&operator_id={{ request.GET.operator_id }}{% endif %}{% if request.GET.machine_id %}&machine_id={{ request.GET.machine_id }}{% endif %}{% if request.GET.category_id %}&category_id={{ request.GET.category_id }}{% endif %}{% if request.GET.operator_data %}&operator_data={{ request.GET.operator_data }}{% endif %}{% if request.GET.collective %}&collective={{ request.GET.collective }}{% endif %}{% if request.GET.moshakhase %}&moshakhase={{ request.GET.moshakhase }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.operator_id %}&operator_id={{ request.GET.operator_id }}{% endif %}{% if request.GET.machine_id %}&machine_id={{ request.GET.machine_id }}{% endif %}{% if request.GET.category_id %}&category_id={{ request.GET.category_id }}{% endif %}{% if request.GET.operator_data %}&operator_data={{ request.GET.operator_data }}{% endif %}{% if request.GET.collective %}&collective={{ request.GET.collective }}{% endif %}{% if request.GET.moshakhase %}&moshakhase={{ request.GET.moshakhase }}{% endif %}" aria-label="Next">
                            <span aria-hidden="true">بعدی</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" href="#" aria-label="Next">
                            <span aria-hidden="true">بعدی</span>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>

<!-- نمودارها -->
<!-- <div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="bi bi-bar-chart"></i> تولید روزانه
            </div>
            <div class="card-body">
                <canvas id="productionChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-pie-chart"></i> توزیع ضایعات بر اساس دستگاه
            </div>
            <div class="card-body">
                <canvas id="wasteChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div> -->









{% endblock %}
{% block javascript %}
<!-- Chartjs -->
<script src="{% static 'vendors/charts/chartjs/chart.min.js' %}"></script>
<!-- Apex chart -->
<script src="{% static 'vendors/charts/apex/apexcharts.min.js' %}"></script>

<!-- Circle progress -->
<script src="{% static 'vendors/circle-progress/circle-progress.min.js' %}"></script>


<script src="{% static 'vendors/select2/js/select2.min.js' %}"></script>

<script>
    $(document).ready(function(){
        $('#startDate,#endDate').pDatepicker({
                format: 'YYYY-MM-DD',
                autoClose: true,
                initialValueType: 'gregorian',
                calendar:{
                  persian: {
                      leapYearMode: 'astronomical'
                  }
              }
              });
              initializeSelect2();
              function initializeSelect2() {
    $('.operator-name').select2({
      dropdownParent: $('body'),
      multiple: true, // Enable multiple selection
      ajax: {
          url: '/api/operators/search/', // Replace with your actual endpoint
          dataType: 'json',
          delay: 250,
          data: function (params) {
              return {
                  q: params.term, // search term
                  page: params.page || 1
              };
          },
          processResults: function (data, params) {
              params.page = params.page || 1;
              
              return {
                  results: data.results.map(function(item) {
                      return {
                          id: item.id,
                          text: item.name + ' (' + item.personnel_number + ')',
                          personnel_number: item.personnel_number,
                          name: item.name,
                          pid: item.pid,
                          cp_code: item.cp_code,
                          card_no: item.card_no,
                          first_name: item.first_name,
                          last_name: item.last_name
                      };
                  }),
                  pagination: {
                      more: data.has_more
                  }
              };
          },
          cache: true
      },
      placeholder: 'انتخاب اپراتور(ها)',
      
      minimumInputLength: 2,
      closeOnSelect: false, // Keep dropdown open after selection for multiple picks
      language: {
          inputTooShort: function () {
              return "حداقل 2 کاراکتر وارد کنید";
          },
          searching: function () {
              return "در حال جستجو...";
          },
          noResults: function () {
              return "نتیجه‌ای یافت نشد";
          },
          errorLoading: function () {
              return "خطا در بارگذاری نتایج";
          }
      },
      dir: "rtl" // RTL support for Persian/Arabic text
  });
  // Handle selection event for multiple operators
$('.operator-name').on('select2:select', function (e) {
    var data = e.params.data;
    var $row = $(this).closest('div');    
    updateOperatorHiddenFields($row);    
});

// Handle unselecting an operator
$('.operator-name').on('select2:unselect', function (e) {
    var data = e.params.data;
    var $row = $(this).closest('div');
    
    updateOperatorHiddenFields($row);
    
});

// Handle clearing all selections
$('.operator-name').on('select2:clear', function (e) {
    var $row = $(this).closest('div');
    
    // Clear all hidden fields
    $row.find('.operator-data').val('');
});
  }
  function updateOperatorHiddenFields($row) {
  // Get currently selected operators from Select2
  var selectedOperators = $row.find('.operator-name').select2('data');
  var selectedIds = selectedOperators.map(op => op.id);
  
  // Get existing data from hidden field
  var existingData = [];
  var currentValue = $row.find('.operator-data').val();
  
  if (currentValue) {
    try {
      existingData = JSON.parse(currentValue);
      // Convert old format if needed
      if (!Array.isArray(existingData)) {
        existingData = convertOldFormatToArray(existingData);
      }
    } catch (e) {
      console.error("Error parsing operator data", e);
    }
  }
  
  // Filter out any existing operators that are no longer selected
  var updatedOperators = existingData.filter(op => 
    selectedIds.includes(op.id)
  );
  
  // Add any newly selected operators that aren't already in the data
  selectedOperators.forEach(newOp => {
    if (!updatedOperators.some(op => op.id === newOp.id)) {
      updatedOperators.push({
        id: newOp.id,
        personnel_number: newOp.personnel_number,
        pid: newOp.pid,
        cp_code: newOp.cp_code,
        card_no: newOp.card_no,
        name: newOp.name
      });
    }
  });
  
  // Update the hidden field
  $row.find('.operator-data').val(JSON.stringify(updatedOperators));
}

// Convert old format {ids:[], names:[]} to new format [{id:..., name:...}]
function convertOldFormatToArray(oldData) {
  if (!oldData.ids) return [];
  
  return oldData.ids.map((id, index) => ({
    id: id,
    personnel_number: oldData.personnel_numbers?.[index] || null,
    pid: oldData.pids?.[index] || null,
    cp_code: oldData.cp_codes?.[index] || null,
    card_no: oldData.card_nos?.[index] || null,
    name: oldData.names?.[index] || null
  }));
}
    });
    function initiate_code_nakh(){
          $('.nakh-name').select2({
            dropdownParent: $('body'),
            ajax: {
                url: '/api/moshakhase/search/',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term,
                        page: params.page || 1
                    };
                },
                processResults: function (data, params) {
                    params.page = params.page || 1;
                    
                    return {
                        results: data.results.map(function(item) {
                            return {
                                id: item.id,
                                text: item.name + ' (' + item.color_name + ')',
                                name: item.name,
                                color_id: item.color_id,
                                color_name: item.color_name,
                                tool: item.tool,
                                la: item.la
                            };
                        }),
                        pagination: {
                            more: data.has_more
                        }
                    };
                },
                cache: true
            },
            minimumInputLength: 2,
            language: {
                inputTooShort: function () {
                    return "حداقل 2 کاراکتر وارد کنید";
                },
                searching: function () {
                    return "در حال جستجو...";
                },
                noResults: function () {
                    return "نتیجه‌ای یافت نشد";
                },
                errorLoading: function () {
                    return "خطا در بارگذاری نتایج";
                }
            },
            dir: "rtl"
          });
          
          $('.nakh-name').on('select2:select', function (e) {
              var data = e.params.data;
              var $row = $(this).closest('div');    
              updateOperatorHiddenFields2($row);    
              console.log('Selected operator:', data);
          });
          
          $('.nakh-name').on('select2:unselect', function (e) {
              var data = e.params.data;
              var $row = $(this).closest('div');
              updateOperatorHiddenFields2($row);
              console.log('Unselected operator:', data);
          });
          
          $('.nakh-name').on('select2:clear', function (e) {
              var $row = $(this).closest('div');
              $row.find('.nakh-data').val('');
          });
        }
        
        function updateOperatorHiddenFields2($row) {
          var selectedOperators = $row.find('.nakh-name').select2('data')[0];
          console.log(selectedOperators);
          
          var updatedOperators = {
            id: selectedOperators.id,
            text: selectedOperators.name + ' (' + selectedOperators.color_name + ')',
            name: selectedOperators.name,
            color_id: selectedOperators.pid,
            color_name: selectedOperators.cp_code,
            tool: selectedOperators.tool,
            la: selectedOperators.la
          };
          
          $row.find('.nakh-data').val(JSON.stringify(updatedOperators));
        }
        
        initiate_code_nakh();
</script>

{% endblock %}
