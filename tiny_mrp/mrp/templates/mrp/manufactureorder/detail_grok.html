<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Order Details</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .container-fluid {
            max-width: 1400px;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        .status-draft {
            background-color: #e9ecef;
            color: #6c757d;
        }
        .status-confirmed {
            background-color: #d1e7fd;
            color: #0d6efd;
        }
        .status-progress {
            background-color: #fff3cd;
            color: #664d03;
        }
        .status-done {
            background-color: #d4edda;
            color: #155724;
        }
        .status-canceled {
            background-color: #f8d7da;
            color: #721c24;
        }
        .product-image {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .detail-table {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }
        .detail-table th,
        .detail-table td {
            vertical-align: middle;
            padding: 12px;
        }
        .nav-tabs {
            border-bottom: 1px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            border: none;
            border-bottom: 2px solid transparent;
            color: #6c757d;
            padding: 10px 20px;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            background-color: transparent;
        }
        .nav-tabs .nav-link:hover {
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
        }
        .tab-content {
            padding: 20px;
            background-color: #fff;
            border-radius: 0 0 8px 8px;
        }
        .form-label {
            font-weight: 500;
            color: #212529;
            margin-bottom: 6px;
        }
        .btn-primary {
            background-color: #673ab7; /* Odoo purple */
            border-color: #673ab7;
            border-radius: 6px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background-color: #5e35b1;
            border-color: #5e35b1;
        }
        .btn-outline-secondary {
            border-radius: 6px;
        }
        .chatter-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }
        .chatter-section h6 {
            font-weight: 600;
            color: #212529;
        }
        .action-buttons .btn {
            margin-right: 8px;
        }
        .forecast-chart {
            max-height: 300px;
        }
        .back-button {
            color: #673ab7;
            text-decoration: none;
            font-weight: 500;
        }
        .back-button:hover {
            color: #5e35b1;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="gpt.html" class="back-button"><i class="fas fa-arrow-left me-2"></i>Back to Manufacturing Orders</a>
                <h1 class="fw-bold text-dark mt-2"><i class="fas fa-industry me-2"></i>Manufacturing Order Details</h1>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="confirmBtn" style="display: none;"><i class="fas fa-check me-1"></i>Confirm</button>
                <button class="btn btn-primary" id="progressBtn" style="display: none;"><i class="fas fa-play me-1"></i>Start Progress</button>
                <button class="btn btn-primary" id="doneBtn" style="display: none;"><i class="fas fa-flag-checkered me-1"></i>Mark as Done</button>
                <button class="btn btn-outline-danger" id="cancelBtn" style="display: none;"><i class="fas fa-times me-1"></i>Cancel</button>
                <button class="btn btn-outline-secondary" id="editBtn"><i class="fas fa-edit me-1"></i>Edit</button>
            </div>
        </div>

        <!-- Order Details Card -->
        <div class="card">
            <div class="card-body p-4">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h3 id="orderReference" class="fw-bold text-dark mb-3"></h3>
                        <div class="d-flex align-items-center mb-3">
                            <img id="productImage" class="product-image me-2">
                            <h5 id="productName" class="mb-0"></h5>
                        </div>
                        <p><strong>Status:</strong> <span id="orderStatus" class="status-badge"></span></p>
                        <p><strong>Quantity:</strong> <span id="orderQuantity"></span></p>
                        <p><strong>Bill of Materials:</strong> <span id="orderBom"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Scheduled Date:</strong> <span id="orderDate"></span></p>
                        <p><strong>Customer:</strong> <span id="orderCustomer"></span></p>
                        <p><strong>Responsible:</strong> <span id="orderResponsible"></span></p>
                        <p><strong>Notes:</strong> <span id="orderNotes" class="text-muted"></span></p>
                    </div>
                </div>

                <!-- Tabs for Components, Work Orders, and Forecast -->
                <ul class="nav nav-tabs mb-3" id="orderTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="components-tab" data-bs-toggle="tab" data-bs-target="#components" type="button" role="tab" aria-controls="components" aria-selected="true">Components</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="workorders-tab" data-bs-toggle="tab" data-bs-target="#workorders" type="button" role="tab" aria-controls="workorders" aria-selected="false">Work Orders</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast" type="button" role="tab" aria-controls="forecast" aria-selected="false">Forecast</button>
                    </li>
                </ul>

                <div class="tab-content" id="orderTabContent">
                    <!-- Components Tab -->
                    <div class="tab-pane fade show active" id="components" role="tabpanel" aria-labelledby="components-tab">
                        <div class="table-responsive">
                            <table class="table table-sm detail-table">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Quantity</th>
                                        <th>Unit of Measure</th>
                                        <th>Available</th>
                                    </tr>
                                </thead>
                                <tbody id="componentsTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No components available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Work Orders Tab -->
                    <div class="tab-pane fade" id="workorders" role="tabpanel" aria-labelledby="workorders-tab">
                        <div class="table-responsive">
                            <table class="table table-sm detail-table">
                                <thead>
                                    <tr>
                                        <th>Work Order</th>
                                        <th>Work Center</th>
                                        <th>Duration (hours)</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody id="workOrdersTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No work orders available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Forecast Tab -->
                    <div class="tab-pane fade" id="forecast" role="tabpanel" aria-labelledby="forecast-tab">
                        <div id="forecastError" class="alert alert-danger d-none" role="alert"></div>
                        <h6 class="fw-bold mb-3">Component Availability</h6>
                        <canvas id="componentChart" class="forecast-chart mb-4"></canvas>
                        <h6 class="fw-bold mb-3">Production Timeline</h6>
                        <div id="timelineInfo" class="mb-4">
                            <p class="text-muted">No work orders available to estimate production timeline.</p>
                        </div>
                        <h6 class="fw-bold mb-3">Stock Status</h6>
                        <div id="stockStatus" class="mb-4">
                            <p class="text-muted">No components available to assess stock status.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chatter Section -->
        <div class="chatter-section">
            <h6 class="mb-3">Chatter</h6>
            <div class="mb-3">
                <textarea class="form-control" id="chatterNotes" rows="4" placeholder="Add a note..."></textarea>
            </div>
            <button class="btn btn-primary" id="addNoteBtn"><i class="fas fa-plus me-1"></i>Add Note</button>
            <div id="chatterLog" class="mt-3">
                <!-- Notes will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Chart.js (UMD version for non-module compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // Sample JSON data (same as previous implementation)
        const manufacturingOrders = [
            {
                id: 1,
                reference: "MO/2023/0001",
                product: { id: 1, name: "Office Desk", code: "OD-1001", image: "/media/products/office-desk.jpg" },
                quantity: 10.0,
                bom: "BOM-OD-1001",
                workOrders: [{ id: "WO-2023-001", workCenter: "Assembly Line 1", duration: 2.5, description: "Assemble desk frame" }],
                status: "draft",
                scheduledDate: "2023-06-15",
                customer: { id: 1, name: "Acme Corp" },
                responsible: { id: 1, name: "John Doe" },
                notes: "Urgent order for client XYZ"
            },
            {
                id: 2,
                reference: "MO/2023/0002",
                product: { id: 2, name: "Office Chair", code: "OC-2001", image: "/media/products/office-chair.jpg" },
                quantity: 15.0,
                bom: "BOM-OC-2001",
                workOrders: [{ id: "WO-2023-002", workCenter: "Assembly Line 2", duration: 3.0, description: "Chair assembly and upholstery" }],
                status: "confirmed",
                scheduledDate: "2023-06-16",
                customer: { id: 2, name: "Beta Industries" },
                responsible: { id: 2, name: "Jane Smith" },
                notes: "Standard production"
            },
            {
                id: 3,
                reference: "MO/2023/0003",
                product: { id: 3, name: "Bookshelf", code: "BS-3001", image: "/media/products/bookshelf.jpg" },
                quantity: 5.0,
                bom: "BOM-BS-3001",
                workOrders: [{ id: "WO-2023-003", workCenter: "Finishing Station", duration: 4.0, description: "Apply custom color finish" }],
                status: "progress",
                scheduledDate: "2023-06-14",
                customer: { id: 3, name: "Gamma Retail" },
                responsible: { id: 3, name: "Mike Johnson" },
                notes: "Custom color requested"
            },
            {
                id: 4,
                reference: "MO/2023/0004",
                product: { id: 4, name: "Coffee Table", code: "CT-4001", image: "/media/products/coffee-table.jpg" },
                quantity: 8.0,
                bom: "BOM-CT-4001",
                workOrders: [],
                status: "done",
                scheduledDate: "2023-06-10",
                customer: null,
                responsible: { id: 4, name: "Sarah Williams" },
                notes: "Completed ahead of schedule"
            },
            {
                id: 5,
                reference: "MO/2023/0005",
                product: { id: 1, name: "Office Desk", code: "OD-1001", image: "/media/products/office-desk.jpg" },
                quantity: 12.0,
                bom: "BOM-OD-1001",
                workOrders: [{ id: "WO-2023-004", workCenter: "Packaging", duration: 1.5, description: "Pack desks for shipping" }],
                status: "canceled",
                scheduledDate: "2023-06-12",
                customer: { id: 1, name: "Acme Corp" },
                responsible: { id: 1, name: "John Doe" },
                notes: "Client canceled order"
            }
        ];

        const products = [
            { id: 1, name: "Office Desk", code: "OD-1001", image: "/media/products/office-desk.jpg" },
            { id: 2, name: "Office Chair", code: "OC-2001", image: "/media/products/office-chair.jpg" },
            { id: 3, name: "Bookshelf", code: "BS-3001", image: "/media/products/bookshelf.jpg" },
            { id: 4, name: "Coffee Table", code: "CT-4001", image: "/media/products/coffee-table.jpg" }
        ];

        const boms = [
            { id: 1, name: "BOM-OD-1001", productId: 1, description: "Office Desk" },
            { id: 2, name: "BOM-OC-2001", productId: 2, description: "Office Chair" },
            { id: 3, name: "BOM-BS-3001", productId: 3, description: "Bookshelf" },
            { id: 4, name: "BOM-CT-4001", productId: 4, description: "Coffee Table" }
        ];

        const bomComponents = [
            { 
                bomId: 1, 
                components: [
                    { name: 'Wood Plank (120cm)', qty: 2, uom: 'Units', available: 25 },
                    { name: 'Metal Bracket', qty: 4, uom: 'Units', available: 60 },
                    { name: 'Wood Screw 3x40mm', qty: 12, uom: 'Units', available: 200 }
                ]
            },
            { 
                bomId: 2, 
                components: [
                    { name: 'Plastic Seat', qty: 1, uom: 'Units', available: 15 },
                    { name: 'Metal Legs', qty: 4, uom: 'Units', available: 40 },
                    { name: 'Wheels', qty: 5, uom: 'Units', available: 35 }
                ]
            },
            { 
                bomId: 3, 
                components: [
                    { name: 'Wood Panel (60x180cm)', qty: 3, uom: 'Units', available: 12 },
                    { name: 'Shelf Bracket', qty: 8, uom: 'Units', available: 45 },
                    { name: 'Wood Screw 3x30mm', qty: 24, uom: 'Units', available: 180 }
                ]
            },
            { 
                bomId: 4, 
                components: [
                    { name: 'Glass Top (80x80cm)', qty: 1, uom: 'Units', available: 8 },
                    { name: 'Metal Frame', qty: 1, uom: 'Units', available: 10 },
                    { name: 'Rubber Feet', qty: 4, uom: 'Units', available: 32 }
                ]
            }
        ];

        let componentChart = null;

        $(document).ready(function() {
            // Get order ID from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = parseInt(urlParams.get('orderId'));
            const order = manufacturingOrders.find(o => o.id === orderId);

            if (!order) {
                alert('Manufacturing order not found!');
                window.location.href = 'gpt.html';
                return;
            }

            // Load order details
            loadOrderDetails(order);

            // Update action buttons based on status
            updateActionButtons(order.status);

            // Load components
            loadComponents(order);

            // Load work orders
            loadWorkOrders(order);

            // Load forecast
            loadForecast(order);

            // Action button handlers
            $('#confirmBtn').click(function() {
                updateOrderStatus(order, 'confirmed');
            });

            $('#progressBtn').click(function() {
                updateOrderStatus(order, 'progress');
            });

            $('#doneBtn').click(function() {
                updateOrderStatus(order, 'done');
            });

            $('#cancelBtn').click(function() {
                updateOrderStatus(order, 'canceled');
            });

            $('#editBtn').click(function() {
                alert('Edit functionality not implemented in this demo.');
                // In a real app, redirect to an edit form or open a modal
            });

            // Chatter note handler
            $('#addNoteBtn').click(function() {
                const note = $('#chatterNotes').val().trim();
                if (note) {
                    const timestamp = new Date().toLocaleString();
                    const noteHtml = `
                        <div class="border-bottom py-2">
                            <p class="mb-1"><strong>User</strong> <small class="text-muted">${timestamp}</small></p>
                            <p class="mb-0">${note}</p>
                        </div>
                    `;
                    $('#chatterLog').prepend(noteHtml);
                    $('#chatterNotes').val('');
                }
            });
        });

        // Function to load order details
        function loadOrderDetails(order) {
            $('#orderReference').text(order.reference);
            $('#productImage').attr('src', order.product.image);
            $('#productName').text(`${order.product.name} (${order.product.code})`);
            
            let statusText = '';
            let statusClass = '';
            switch(order.status) {
                case 'draft': statusText = 'Draft'; statusClass = 'status-draft'; break;
                case 'confirmed': statusText = 'Confirmed'; statusClass = 'status-confirmed'; break;
                case 'progress': statusText = 'In Progress'; statusClass = 'status-progress'; break;
                case 'done': statusText = 'Done'; statusClass = 'status-done'; break;
                case 'canceled': statusText = 'Canceled'; statusClass = 'status-canceled'; break;
            }
            $('#orderStatus').text(statusText).addClass(statusClass);
            
            $('#orderQuantity').text(order.quantity.toFixed(1));
            $('#orderBom').text(order.bom);
            $('#orderDate').text(order.scheduledDate);
            $('#orderCustomer').text(order.customer ? order.customer.name : 'None');
            $('#orderResponsible').text(order.responsible ? order.responsible.name : 'None');
            $('#orderNotes').text(order.notes || 'No notes');
        }

        // Function to update action buttons based on status
        function updateActionButtons(status) {
            $('#confirmBtn, #progressBtn, #doneBtn, #cancelBtn').hide();
            switch(status) {
                case 'draft':
                    $('#confirmBtn, #cancelBtn').show();
                    break;
                case 'confirmed':
                    $('#progressBtn, #cancelBtn').show();
                    break;
                case 'progress':
                    $('#doneBtn, #cancelBtn').show();
                    break;
                case 'done':
                case 'canceled':
                    // No action buttons for final states
                    break;
            }
        }

        // Function to update order status
        function updateOrderStatus(order, newStatus) {
            order.status = newStatus;
            loadOrderDetails(order);
            updateActionButtons(newStatus);
            alert(`Order status updated to ${newStatus}!`);
        }

        // Function to load components
        function loadComponents(order) {
            const bom = boms.find(b => b.name === order.bom);
            if (!bom) {
                $('#componentsTableBody').html('<tr><td colspan="4" class="text-center text-muted">No BOM found</td></tr>');
                return;
            }

            const bomData = bomComponents.find(bc => bc.bomId === bom.id);
            const components = bomData ? bomData.components : [];
            const quantity = order.quantity;

            if (components.length === 0) {
                $('#componentsTableBody').html('<tr><td colspan="4" class="text-center text-muted">No components defined</td></tr>');
                return;
            }

            let rows = '';
            components.forEach(component => {
                const totalQty = component.qty * quantity;
                const statusClass = totalQty <= component.available ? 'bg-success' : 'bg-danger';
                rows += `
                    <tr>
                        <td>${component.name}</td>
                        <td>${totalQty.toFixed(1)}</td>
                        <td>${component.uom}</td>
                        <td><span class="badge ${statusClass}">${component.available.toFixed(1)}</span></td>
                    </tr>
                `;
            });
            $('#componentsTableBody').html(rows);
        }

        // Function to load work orders
        function loadWorkOrders(order) {
            const workOrders = order.workOrders || [];
            if (workOrders.length === 0) {
                $('#workOrdersTableBody').html('<tr><td colspan="4" class="text-center text-muted">No work orders available</td></tr>');
                return;
            }

            let rows = '';
            workOrders.forEach(wo => {
                rows += `
                    <tr>
                        <td>${wo.id}</td>
                        <td>${wo.workCenter}</td>
                        <td>${wo.duration.toFixed(1)}</td>
                        <td>${wo.description || 'No description'}</td>
                    </tr>
                `;
            });
            $('#workOrdersTableBody').html(rows);
        }

        // Function to load forecast
        function loadForecast(order) {
            const bom = boms.find(b => b.name === order.bom);
            const quantity = order.quantity;

            // Validate required fields
            if (!order.product || !bom || !quantity || quantity <= 0) {
                let errorMsg = 'Unable to generate forecast: ';
                if (!order.product) errorMsg += 'No product selected. ';
                if (!bom) errorMsg += 'No Bill of Materials selected. ';
                if (!quantity || quantity <= 0) errorMsg += 'Invalid quantity.';
                $('#forecastError').text(errorMsg).removeClass('d-none');
                return;
            } else {
                $('#forecastError').addClass('d-none');
            }

            const bomData = bomComponents.find(bc => bc.bomId === bom.id);
            const components = bomData ? bomData.components : [];

            // Component Availability Chart
            if (componentChart) {
                componentChart.destroy();
            }

            const labels = components.map(c => c.name);
            const requiredData = components.map(c => c.qty * quantity);
            const availableData = components.map(c => c.available);

            const ctx = document.getElementById('componentChart').getContext('2d');
            try {
                componentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Required Quantity',
                                data: requiredData,
                                backgroundColor: 'rgba(0, 123, 255, 0.5)',
                                borderColor: 'rgba(0, 123, 255, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Available Quantity',
                                data: availableData,
                                backgroundColor: 'rgba(40, 167, 69, 0.5)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantity'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Components'
                                }
                            }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            title: {
                                display: true,
                                text: 'Component Availability Forecast'
                            }
                        }
                    }
                });
                console.log('Chart created successfully');
            } catch (e) {
                console.error('Error creating chart:', e);
                $('#forecastError').text('Error generating forecast chart.').removeClass('d-none');
            }

            // Production Timeline
            const workOrders = order.workOrders || [];
            const totalDuration = workOrders.reduce((sum, wo) => sum + parseFloat(wo.duration), 0);
            const timelineHtml = workOrders.length > 0 ? `
                <p><strong>Total Duration:</strong> ${totalDuration.toFixed(1)} hours</p>
                <ul>
                    ${workOrders.map(wo => `
                        <li>${wo.id} (${wo.workCenter}): ${wo.duration} hours - ${wo.description || 'No description'}</li>
                    `).join('')}
                </ul>
            ` : '<p class="text-muted">No work orders available to estimate production timeline.</p>';
            $('#timelineInfo').html(timelineHtml);

            // Stock Status
            const allSufficient = components.every(c => c.qty * quantity <= c.available);
            const stockStatusHtml = components.length > 0 ? `
                <p><strong>Stock Sufficiency:</strong> 
                    <span class="${allSufficient ? 'text-success' : 'text-danger'}">
                        ${allSufficient ? 'Sufficient stock for all components' : 'Insufficient stock for some components'}
                    </span>
                </p>
                <ul>
                    ${components.map(c => `
                        <li>${c.name}: ${c.qty * quantity.toFixed(1)} required, ${c.available.toFixed(1)} available 
                            <span class="${c.qty * quantity <= c.available ? 'text-success' : 'text-danger'}">
                                (${c.qty * quantity <= c.available ? 'OK' : 'Shortage'})
                            </span>
                        </li>
                    `).join('')}
                </ul>
            ` : '<p class="text-muted">No components defined for this BOM.</p>';
            $('#stockStatus').html(stockStatusHtml);
        }
    </script>
</body>
</html>