<!-- templates/mrp/inventory/low_stock_products.html -->
{% extends 'mrp/blank-page.html' %}
{% load static %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning">
                <h4 class="card-title mb-0">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    کالاهای با موجودی ناکافی
                </h4>
            </div>
            <div class="card-body">
                <!-- آمار کلی -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-danger-bright text-danger">
                            <div class="card-body text-center font-weight-bold">
                                <h3 >{{ total_critical }}</h3>
                                <h2 class="font-weight-bold">کالای بحرانی</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark-bright text-dark">
                            <div class="card-body text-center font-weight-bold">
                                <h2>{{ total_medium }}</h2>
                                <h2 class="font-weight-bold">کالای با کمبود متوسط</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info-bright text-info">
                            <div class="card-body text-center font-weight-bold">
                                <h3>{{ low_stock_products|length }}</h3>
                                <h2 class="font-weight-bold">کل کالاهای با کمبود</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- جدول کالاها -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-info">
                            <tr>
                                <th>#</th>
                                <th>نام کالا</th>
                                <th>کد کالا</th>
                                <th>نوع کالا</th>
                                <th>موجودی فعلی</th>
                                <th>مقدار مورد نیاز</th>
                                <th>مقدار کمبود</th>
                                <th>درصد کمبود</th>
                                <th>سطح بحرانی</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_products %}
                            <tr class="{% if item.critical_level == 'high' %}table-danger{% else %}table-warning{% endif %}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ item.product.name }}</strong>
                                </td>
                                <td>{{ item.product.code }}</td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ item.product.get_product_type_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-primary">
                                        {{ item.available_quantity|floatformat:2 }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">
                                        {{ item.required_quantity|floatformat:2 }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-danger">
                                        {{ item.shortage|floatformat:2 }}
                                    </span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if item.shortage_percentage > 50 %}bg-danger{% else %}bg-warning{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ item.shortage_percentage }}%"
                                             aria-valuenow="{{ item.shortage_percentage }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ item.shortage_percentage|floatformat:1 }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if item.critical_level == 'high' %}
                                        <span class="badge bg-danger">بحرانی</span>
                                    {% else %}
                                        <span class="badge bg-warning">متوسط</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showProductDetails({{ item.product.id }})">
                                        <i class="fa fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" 
                                            onclick="showPurchaseSuggestions({{ item.product.id }})">
                                        <i class="fa fa-shopping-cart"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-4">
                                    <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                                    <br>
                                    هیچ کالایی با کمبود موجودی یافت نشد.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- مودال جزئیات کالا -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">جزئیات کالا</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- محتوای داینامیک -->
            </div>
        </div>
    </div>
</div>

<!-- مودال پیشنهاد خرید -->
<div class="modal fade" id="purchaseSuggestionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">پیشنهاد خرید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="purchaseSuggestionContent">
                <!-- محتوای داینامیک -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
// در بخش javascript فایل low_stock_products.html
function showProductDetails(productId) {
    // نمایش loading
    $('#productDetailContent').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">در حال بارگذاری...</span>
            </div>
            <p class="mt-2">در حال دریافت اطلاعات کالا...</p>
        </div>
    `);
    $('#productDetailModal').modal('show');

    // درخواست AJAX برای دریافت جزئیات
    $.ajax({
        url: `/api/products/${productId}/detail/`,
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                const product = response.product;
                const inventory = response.inventory_info;
                const orders = response.related_orders;

                let ordersHtml = '';
                if (orders.length > 0) {
                    orders.forEach(order => {
                        ordersHtml += `
                            <div class="border-bottom pb-2 mb-2">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>سفارش:</strong> ${order.order_reference}
                                    </div>
                                    <div class="col-6">
                                        <span class="badge bg-secondary">${order.order_status}</span>
                                    </div>
                                </div>
                                <div class="row mt-1">
                                    <div class="col-6">
                                        <small>BOM: ${order.bom_reference}</small>
                                    </div>
                                    <div class="col-6">
                                        <small>مقدار مورد نیاز: ${order.required_quantity}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    ordersHtml = '<p class="text-muted">هیچ سفارش فعالی برای این کالا وجود ندارد.</p>';
                }

                $('#productDetailContent').html(`
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">اطلاعات اصلی کالا</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td width="40%"><strong>نام:</strong></td>
                                            <td>${product.name}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>کد:</strong></td>
                                            <td>${product.code}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>نوع:</strong></td>
                                            <td>
                                                <span class="badge bg-secondary">${product.product_type_display}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>واحد اندازه‌گیری:</strong></td>
                                            <td>${product.unit_of_measure_display}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>وضعیت موجودی:</strong></td>
                                            <td>
                                                <span class="badge ${product.stock_status === 'out_of_stock' ? 'bg-danger' : product.stock_status === 'low_stock' ? 'bg-warning' : 'bg-success'}">
                                                    ${product.stock_status_display}
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">اطلاعات مالی</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td width="40%"><strong>قیمت تمام شده:</strong></td>
                                            <td>${product.cost_price.toLocaleString()} ریال</td>
                                        </tr>
                                        <tr>
                                            <td><strong>قیمت فروش:</strong></td>
                                            <td>${product.sale_price.toLocaleString()} ریال</td>
                                        </tr>
                                        <tr>
                                            <td><strong>موجودی فعلی:</strong></td>
                                            <td>
                                                <span class="badge bg-primary">${product.available_quantity}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>آخرین بروزرسانی:</strong></td>
                                            <td><small>${product.updated_at}</small></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header ${inventory.is_sufficient ? 'bg-success' : 'bg-warning'} text-white">
                                    <h6 class="mb-0">وضعیت موجودی نسبت به سفارشات</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 text-center">
                                            <h4>${product.available_quantity}</h4>
                                            <small>موجودی فعلی</small>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <h4 class="${inventory.is_sufficient ? 'text-success' : 'text-danger'}">${inventory.total_required}</h4>
                                            <small>مقدار مورد نیاز</small>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <h4>${inventory.coverage_ratio.toFixed(1)}%</h4>
                                            <small>نسبت پوشش</small>
                                        </div>
                                    </div>
                                    <div class="progress mt-3" style="height: 25px;">
                                        <div class="progress-bar ${inventory.coverage_ratio >= 100 ? 'bg-success' : inventory.coverage_ratio >= 50 ? 'bg-warning' : 'bg-danger'}" 
                                             role="progressbar" 
                                             style="width: ${Math.min(inventory.coverage_ratio, 100)}%"
                                             aria-valuenow="${inventory.coverage_ratio}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            ${inventory.coverage_ratio.toFixed(1)}% پوشش
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">سفارشات مرتبط (${orders.length})</h6>
                                </div>
                                <div class="card-body">
                                    ${ordersHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            } else {
                $('#productDetailContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        خطا در دریافت اطلاعات: ${response.error}
                    </div>
                `);
            }
        },
        error: function(xhr, status, error) {
            $('#productDetailContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    خطا در ارتباط با سرور: ${error}
                </div>
            `);
        }
    });
}

function showPurchaseSuggestions(productId) {
    // نمایش loading
    $('#purchaseSuggestionContent').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">در حال بارگذاری...</span>
            </div>
            <p class="mt-2">در حال محاسبه پیشنهاد خرید...</p>
        </div>
    `);
    $('#purchaseSuggestionModal').modal('show');

    // درخواست AJAX برای دریافت پیشنهاد خرید
    $.ajax({
        url: `/api/products/${productId}/purchase-suggestion/`,
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                const product = response.product;
                const calculation = response.calculation;
                const suggestion = response.suggestion;

                $('#purchaseSuggestionContent').html(`
                    <div class="alert alert-${suggestion.urgency_level === 'high' ? 'danger' : suggestion.urgency_level === 'medium' ? 'warning' : 'info'}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>${response.recommendation}</strong>
                            </div>
                            <span class="badge bg-${suggestion.urgency_level === 'high' ? 'danger' : suggestion.urgency_level === 'medium' ? 'warning' : 'info'}">
                                ${suggestion.urgency_display}
                            </span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">محاسبات موجودی</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td width="60%">موجودی فعلی:</td>
                                            <td><strong>${calculation.current_stock}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>مقدار مورد نیاز:</td>
                                            <td><strong>${calculation.total_required}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>کمبود فعلی:</td>
                                            <td><strong class="text-danger">${calculation.shortage}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>موجودی ایمنی:</td>
                                            <td><strong>${calculation.safety_stock.toFixed(1)}</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">پیشنهاد خرید</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td width="60%">مقدار پیشنهادی:</td>
                                            <td><strong class="text-success">${suggestion.suggested_quantity}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>هزینه تخمینی:</td>
                                            <td><strong>${suggestion.estimated_cost.toLocaleString()} ریال</strong></td>
                                        </tr>
                                        <tr>
                                            <td>حداقل سفارش:</td>
                                            <td><strong>${suggestion.min_order_quantity}</strong></td>
                                        </tr>
                                        <tr>
                                            <td>زمان تحویل:</td>
                                            <td><strong>${suggestion.estimated_delivery_time}</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">توضیحات</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">${suggestion.supplier_notes}</p>
                            <small class="text-muted">
                                این پیشنهاد بر اساس تحلیل سفارشات فعال و موجودی فعلی محاسبه شده است.
                            </small>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <button class="btn btn-success btn-lg me-2" onclick="createPurchaseOrder(${product.id}, ${suggestion.suggested_quantity})">
                            <i class="fas fa-file-invoice me-2"></i>
                            ایجاد سفارش خرید (${suggestion.suggested_quantity} واحد)
                        </button>
                        <button class="btn btn-outline-secondary" onclick="adjustPurchaseQuantity(${product.id})">
                            <i class="fas fa-edit me-2"></i>
                            تنظیم مقدار دستی
                        </button>
                    </div>
                `);
            } else {
                $('#purchaseSuggestionContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        خطا در محاسبه پیشنهاد: ${response.error}
                    </div>
                `);
            }
        },
        error: function(xhr, status, error) {
            $('#purchaseSuggestionContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    خطا در ارتباط با سرور: ${error}
                </div>
            `);
        }
    });
}

function createPurchaseOrder(productId, quantity) {
    // ایجاد سفارش خرید
    const data = {
        product_id: productId,
        quantity: quantity
    };

    $.ajax({
        url: '/api/purchase-orders/create/',
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        dataType: 'json',
        success: function(response) {
            if (response.success) {
                alert(response.message);
                $('#purchaseSuggestionModal').modal('hide');
                // می‌توانید صفحه را refresh کنید یا اطلاعات را به‌روزرسانی کنید
                location.reload();
            } else {
                alert('خطا در ایجاد سفارش: ' + response.error);
            }
        },
        error: function(xhr, status, error) {
            alert('خطا در ارتباط با سرور: ' + error);
        }
    });
}

function adjustPurchaseQuantity(productId) {
    const newQuantity = prompt('لطفاً مقدار مورد نظر برای خرید را وارد کنید:');
    if (newQuantity && !isNaN(newQuantity) && parseInt(newQuantity) > 0) {
        createPurchaseOrder(productId, parseInt(newQuantity));
    } else if (newQuantity !== null) {
        alert('لطفاً یک عدد معتبر وارد کنید.');
    }
}
</script>

<style>
.progress {
    background-color: #e9ecef;
    border-radius: 4px;
}
.progress-bar {
    border-radius: 4px;
    font-size: 12px;
    line-height: 20px;
}
.table-danger {
    background-color: #f8d7da !important;
}
.table-warning {
    background-color: #fff3cd !important;
}
</style>
{% endblock %}