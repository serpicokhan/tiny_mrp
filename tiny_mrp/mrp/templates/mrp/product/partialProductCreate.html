{% extends 'mrp/blank-page.html' %}
{% block stylesheet %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .product-card {
        transition: transform 0.2s, box-shadow 0.2s;
        margin-bottom: 20px;
        height: 100%;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .product-type-badge {
        position: absolute;
        top: 10px;
        left: 10px;
    }
    .product-price {
        font-weight: bold;
        font-size: 1.1rem;
    }
    .product-cost {
        color: #dc3545;
    }
    .product-sale {
        color: #28a745;
    }
    .product-stock {
        font-weight: bold;
    }
    .in-stock {
        color: #28a745;
    }
    .low-stock {
        color: #ffc107;
    }
    .out-of-stock {
        color: #dc3545;
    }
    .search-box {
        margin-bottom: 20px;
    }
    .action-buttons .btn {
        margin-right: 5px;
    }
    .table-responsive {
        overflow-x: auto;
    }
</style>
{% endblock %}
{% block content %}
{% load static %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-boxes mr-2"></i>مدیریت محصول</h2>
    </div>
    <div class="">
        <button class="btn btn-primary" id="create-product-btn">
            <i class="fas fa-plus me-1"></i> محصول جدید
        </button>
    </div>
</div>

<!-- Search and Filter -->
<div class="row search-box">
    <div class="col-md-4">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="جستجوی محصول" id="product-search">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-control" id="type-filter">
            <option value="">همه</option>
            <option value="raw">Raw Material</option>
            <option value="finished">Finished Good</option>
            <option value="component">Component</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-control" id="stock-filter">
            <option value="">All Stock Levels</option>
            <option value="in_stock">In Stock</option>
            <option value="low_stock">Low Stock</option>
            <option value="out_of_stock">Out of Stock</option>
        </select>
    </div>
    <div class="col-md-2 text-end">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary active" id="view-grid-btn">
                <i class="fas fa-th-large"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="view-list-btn">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>
</div>

<!-- Grid View -->
<div class="row" id="grid-view">
    <!-- Product cards will be loaded here -->
    <div class="col-12 text-center py-5 text-muted" id="empty-products-grid">
        No products found. Click "Create Product" to add one.
    </div>
</div>

<!-- Table View (hidden by default) -->
<div class="table-responsive" id="list-view" style="display: none;">
    <table class="table table-hover">
        <thead class="table-light">
            <tr>
                <th>کد</th>
                <th>نام</th>
                <th>نوع</th>
                <th>هزینه</th>
                <th>قیمت فروش</th>
                <th>انبار</th>
                <th>واحد</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody id="product-table-body">
            <!-- Product rows will be loaded here -->
            <tr>
                <td colspan="8" class="text-center py-5 text-muted" id="empty-products-table">
                    No products found. Click "Create Product" to add one.
                </td>
            </tr>
        </tbody>
    </table>
</div>
   <!-- Product Form Modal -->
   <div class="modal fade" id="product-form-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="product-modal-title">Create New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product-name" class="form-label">Name*</label>
                            <input type="text" class="form-control" id="product-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product-code" class="form-label">Code*</label>
                            <input type="text" class="form-control" id="product-code" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product-type" class="form-label">Type*</label>
                            <select class="form-select" id="product-type" required>
                                <option value="">Select type</option>
                                <option value="raw">Raw Material</option>
                                <option value="finished">Finished Good</option>
                                <option value="component">Component</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product-uom" class="form-label">Unit of Measure*</label>
                            <select class="form-select" id="product-uom" required>
                                <option value="">Select UoM</option>
                                <option value="units">Units</option>
                                <option value="kg">Kilograms</option>
                                <option value="g">Grams</option>
                                <option value="l">Liters</option>
                                <option value="ml">Milliliters</option>
                                <option value="m">Meters</option>
                                <option value="cm">Centimeters</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product-cost" class="form-label">Cost Price*</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="product-cost" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="product-sale" class="form-label">Sale Price*</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min="0" class="form-control" id="product-sale" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product-quantity" class="form-label">Available Quantity*</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="product-quantity" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-product-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="delete-confirm-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock%}
{% block javascript %}
<script>
    $(document).ready(function() {
        // Global variables
        let currentProductId = null;
        let currentView = 'grid'; // 'grid' or 'list'
        
        // Initialize the page
        loadProducts();
        
        // Event handlers
        $('#create-product-btn').click(showCreateProductModal);
        $('#save-product-btn').click(saveProduct);
        $('#confirm-delete-btn').click(deleteProduct);
        $('#product-search').on('keyup', filterProducts);
        $('#type-filter, #stock-filter').change(filterProducts);
        $('#view-grid-btn').click(function() {
            setView('grid');
        });
        $('#view-list-btn').click(function() {
            setView('list');
        });
        
        // Set view type (grid or list)
        function setView(view) {
            currentView = view;
            if (view === 'grid') {
                $('#grid-view').show();
                $('#list-view').hide();
                $('#view-grid-btn').addClass('active');
                $('#view-list-btn').removeClass('active');
            } else {
                $('#grid-view').hide();
                $('#list-view').show();
                $('#view-grid-btn').removeClass('active');
                $('#view-list-btn').addClass('active');
            }
        }
        
        // Load products from server
        function loadProducts() {
            // In a real app, this would be an AJAX call to your Django backend
            // For demo purposes, we'll use mock data
            const mockProducts = [
                {
                    id: 1,
                    name: "محصول الف",
                    code: "FP-001",
                    product_type: "finished",
                    unit_of_measure: "units",
                    cost_price: "15.50",
                    sale_price: "29.99",
                    available_quantity: 25,
                    created_at: "2023-06-10T09:15:00Z",
                    updated_at: "2023-06-15T14:30:00Z"
                },
                {
                    id: 2,
                    name: "محصول ب",
                    code: "RM-001",
                    product_type: "raw",
                    unit_of_measure: "kg",
                    cost_price: "8.75",
                    sale_price: "12.50",
                    available_quantity: 150.5,
                    created_at: "2023-05-20T11:20:00Z",
                    updated_at: "2023-06-12T16:45:00Z"
                },
                {
                    id: 3,
                    name: "محصول پ",
                    code: "CP-001",
                    product_type: "component",
                    unit_of_measure: "units",
                    cost_price: "3.20",
                    sale_price: "5.99",
                    available_quantity: 0,
                    created_at: "2023-06-01T08:30:00Z",
                    updated_at: "2023-06-18T10:15:00Z"
                },
                {
                    id: 4,
                    name: "محصول ث",
                    code: "FP-002",
                    product_type: "finished",
                    unit_of_measure: "units",
                    cost_price: "22.00",
                    sale_price: "45.00",
                    available_quantity: 8,
                    created_at: "2023-06-05T14:00:00Z",
                    updated_at: "2023-06-16T09:30:00Z"
                },
                
            ];
            
            if (mockProducts.length > 0) {
                renderProductGrid(mockProducts);
                renderProductTable(mockProducts);
            } else {
                $('#empty-products-grid').show();
                $('#empty-products-table').show();
            }
        }
        
        // Render product grid
        function renderProductGrid(products) {
            if (products.length > 0) {
                $('#empty-products-grid').hide();
                $('#grid-view').empty();
                
                products.forEach(product => {
                    const stockClass = getStockClass(product.available_quantity);
                    const typeBadgeClass = product.product_type === 'finished' ? 'bg-success' : 
                                         product.product_type === 'raw' ? 'bg-warning text-dark' : 'bg-info';
                    const typeLabel = product.product_type === 'finished' ? 'Finished' : 
                                     product.product_type === 'raw' ? 'Raw' : 'Component';
                    
                    const productCard = $(`
                        <div class="col-md-6 col-lg-4 col-xl-3">
                            <div class="card product-card" data-product-id="${product.id}">
                                <span class="badge ${typeBadgeClass} product-type-badge">${typeLabel}</span>
                                <div class="card-body">
                                    <h5 class="card-title">${product.name}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">${product.code}</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="product-price product-cost">$${product.cost_price}</span>
                                        <span class="product-price product-sale">$${product.sale_price}</span>
                                    </div>
                                    <p class="card-text">
                                        <span class="product-stock ${stockClass}">
                                            ${product.available_quantity} ${product.unit_of_measure}
                                        </span>
                                    </p>
                                    <div class="d-flex justify-content-between action-buttons">
                                        <button class="btn btn-sm btn-outline-primary edit-product-btn">
                                            <i class="fas fa-edit"></i> ویرایش
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-product-btn">
                                            <i class="fas fa-trash"></i> حذف
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted small">
                                    Last updated: ${formatDate(product.updated_at)}
                                </div>
                            </div>
                        </div>
                    `);
                    
                    productCard.find('.edit-product-btn').click(function() {
                        showEditProductModal(product.id);
                    });
                    
                    productCard.find('.delete-product-btn').click(function() {
                        showDeleteConfirmModal(product.id);
                    });
                    
                    $('#grid-view').append(productCard);
                });
            } else {
                $('#empty-products-grid').show();
            }
        }
        
        // Render product table
        function renderProductTable(products) {
            if (products.length > 0) {
                $('#empty-products-table').hide();
                $('#product-table-body').empty();
                
                products.forEach(product => {
                    const stockClass = getStockClass(product.available_quantity);
                    const typeLabel = product.product_type === 'finished' ? 'Finished' : 
                                     product.product_type === 'raw' ? 'Raw' : 'Component';
                    
                    const productRow = $(`
                        <tr data-product-id="${product.id}">
                            <td>${product.code}</td>
                            <td>${product.name}</td>
                            <td><span class="badge bg-secondary">${typeLabel}</span></td>
                            <td>$${product.cost_price}</td>
                            <td>$${product.sale_price}</td>
                            <td><span class="${stockClass}">${product.available_quantity}</span></td>
                            <td>${product.unit_of_measure}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-product-btn">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-product-btn">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                    
                    productRow.find('.edit-product-btn').click(function() {
                        showEditProductModal(product.id);
                    });
                    
                    productRow.find('.delete-product-btn').click(function() {
                        showDeleteConfirmModal(product.id);
                    });
                    
                    $('#product-table-body').append(productRow);
                });
            } else {
                $('#empty-products-table').show();
            }
        }
        
        // Show create product modal
        function showCreateProductModal() {
            $('#product-modal-title').text('Create New Product');
            $('#product-id').val('');
            $('#product-form')[0].reset();
            $('#product-form-modal').modal('show');
        }
        
        // Show edit product modal
        function showEditProductModal(productId) {
            currentProductId = productId;
            
            // In a real app, you would fetch the product data via AJAX
            const mockProducts = [
                {
                    id: 1,
                    name: "Finished Product A",
                    code: "FP-001",
                    product_type: "finished",
                    unit_of_measure: "units",
                    cost_price: "15.50",
                    sale_price: "29.99",
                    available_quantity: 25
                },
                {
                    id: 2,
                    name: "Raw Material X",
                    code: "RM-001",
                    product_type: "raw",
                    unit_of_measure: "kg",
                    cost_price: "8.75",
                    sale_price: "12.50",
                    available_quantity: 150.5
                },
                {
                    id: 3,
                    name: "Component Y",
                    code: "CP-001",
                    product_type: "component",
                    unit_of_measure: "units",
                    cost_price: "3.20",
                    sale_price: "5.99",
                    available_quantity: 0
                },
                {
                    id: 4,
                    name: "Finished Product B",
                    code: "FP-002",
                    product_type: "finished",
                    unit_of_measure: "units",
                    cost_price: "22.00",
                    sale_price: "45.00",
                    available_quantity: 8
                }
            ];
            
            const product = mockProducts.find(p => p.id == productId);
            if (product) {
                $('#product-modal-title').text('Edit Product');
                $('#product-id').val(product.id);
                $('#product-name').val(product.name);
                $('#product-code').val(product.code);
                $('#product-type').val(product.product_type);
                $('#product-uom').val(product.unit_of_measure);
                $('#product-cost').val(product.cost_price);
                $('#product-sale').val(product.sale_price);
                $('#product-quantity').val(product.available_quantity);
                $('#product-form-modal').modal('show');
            }
        }
        
        // Save product (create or update)
        function saveProduct() {
            const form = $('#product-form')[0];
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const productData = {
                id: $('#product-id').val(),
                name: $('#product-name').val(),
                code: $('#product-code').val(),
                product_type: $('#product-type').val(),
                unit_of_measure: $('#product-uom').val(),
                cost_price: $('#product-cost').val(),
                sale_price: $('#product-sale').val(),
                available_quantity: $('#product-quantity').val()
            };
            
            // In a real app, this would be an AJAX call to your Django backend
            console.log('Saving product:', productData);
            
            // Simulate success
            $('#product-form-modal').modal('hide');
            loadProducts(); // Refresh the list
            
            if (productData.id) {
                showToast('Product updated successfully!', 'success');
            } else {
                showToast('Product created successfully!', 'success');
            }
        }
        
        // Show delete confirmation modal
        function showDeleteConfirmModal(productId) {
            currentProductId = productId;
            $('#delete-confirm-modal').modal('show');
        }
        
        // Delete product
        function deleteProduct() {
            $('#delete-confirm-modal').modal('hide');
            
            // In a real app, this would be an AJAX call to your Django backend
            console.log('Deleting product:', currentProductId);
            
            // Simulate success
            currentProductId = null;
            loadProducts(); // Refresh the list
            showToast('Product deleted successfully!', 'success');
        }
        
        // Filter products
        function filterProducts() {
            const searchTerm = $('#product-search').val().toLowerCase();
            const typeFilter = $('#type-filter').val();
            const stockFilter = $('#stock-filter').val();
            
            // In a real app, this would be an AJAX call with filters
            // For demo, we'll just filter the existing mock data
            const mockProducts = [
                {
                    id: 1,
                    name: "Finished Product A",
                    code: "FP-001",
                    product_type: "finished",
                    available_quantity: 25
                },
                {
                    id: 2,
                    name: "Raw Material X",
                    code: "RM-001",
                    product_type: "raw",
                    available_quantity: 150.5
                },
                {
                    id: 3,
                    name: "Component Y",
                    code: "CP-001",
                    product_type: "component",
                    available_quantity: 0
                },
                {
                    id: 4,
                    name: "Finished Product B",
                    code: "FP-002",
                    product_type: "finished",
                    available_quantity: 8
                }
            ];
            
            const filteredProducts = mockProducts.filter(product => {
                const matchesSearch = searchTerm === '' || 
                                    product.name.toLowerCase().includes(searchTerm) || 
                                    product.code.toLowerCase().includes(searchTerm);
                
                const matchesType = typeFilter === '' || product.product_type === typeFilter;
                
                let matchesStock = true;
                if (stockFilter === 'in_stock') {
                    matchesStock = product.available_quantity > 10;
                } else if (stockFilter === 'low_stock') {
                    matchesStock = product.available_quantity > 0 && product.available_quantity <= 10;
                } else if (stockFilter === 'out_of_stock') {
                    matchesStock = product.available_quantity <= 0;
                }
                
                return matchesSearch && matchesType && matchesStock;
            });
            
            renderProductGrid(filteredProducts);
            renderProductTable(filteredProducts);
        }
        
        // Helper function to get stock status class
        function getStockClass(quantity) {
            if (quantity <= 0) return 'out-of-stock';
            if (quantity <= 10) return 'low-stock';
            return 'in-stock';
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        // Helper function to show toast messages
        function showToast(message, type = 'success') {
            // In a real app, you would use a proper toast library
            alert(`${type.toUpperCase()}: ${message}`);
        }
    });
</script>
{% endblock %}
