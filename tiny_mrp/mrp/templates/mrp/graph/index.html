<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نمودار خط تولیدی ریسندگی با جدول و کنترل‌ها</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      direction: rtl;
      font-family: Arial, sans-serif;
    }
    .node circle {
      fill: #fff;
      stroke: #20c997;
      stroke-width: 3px;
      cursor: pointer;
    }
    .node text {
      font: 14px sans-serif;
      text-anchor: start;
      dominant-baseline: middle;
    }
    .link {
      fill: none;
      stroke: #d1e7dd;
      stroke-width: 2.5px;
    }
    #info-table {
      margin: 20px auto;
      max-width: 600px;
    }
    .container-fluid {
      max-width: 1200px;
    }
    .controls {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- کنترل‌های فیلتر -->
    <div class="row controls">
      <div class="col-12">
        <form class="row g-3 justify-content-center">
          <div class="col-md-3">
            <label for="moshakhase" class="form-label">مشخصه</label>
            <input type="number" class="form-control" id="moshakhase" value="123" placeholder="مثال: 123">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-primary" onclick="fetchData()">فیلتر</button>
          </div>
        </form>
      </div>
    </div>
    <!-- نمودار -->
    <div class="row">
      <div class="col-12">
        <svg width="1000" height="600"></svg>
      </div>
    </div>
    <!-- جدول اطلاعات -->
    <div class="row">
      <div class="col-12">
        <div id="info-table" class="text-center"></div>
      </div>
    </div>
  </div>
  <script>
    function fetchData() {
      const moshakhaseId = document.getElementById('moshakhase').value;
      fetch(`/api/production-graph/?moshakhase_id=${moshakhaseId}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error(data.error);
            return;
          }
          update(data.data);
          showTable(d3.hierarchy(data.data));
        })
        .catch(error => console.error('Error fetching data:', error));
    }

    const svg = d3.select("svg"),
          width = +svg.attr("width"),
          height = +svg.attr("height"),
          g = svg.append("g").attr("transform", "translate(40,0)");

    const tree = d3.tree().size([height, width - 160]);

    function showTable(d) {
      const info = d.data.productionInfo || { 
        production: "نامشخص", 
        speed: "نامشخص", 
        wastage: "نامشخص",
        first_day: "نامشخص",
        last_day: "نامشخص",
        first_timestamp: "نامشخص",
        last_timestamp: "نامشخص",
        distinct_days: 0
      };
      const table = `
        <div class="table-responsive">
          <h5>اطلاعات تولید: ${d.data.name}</h5>
          <table class="table table-bordered table-striped mx-auto">
            <thead class="table-light">
              <tr>
                <th>پارامتر</th>
                <th>مقدار</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>مقدار تولید</td>
                <td>${info.production}</td>
              </tr>
              <tr>
                <td>سرعت</td>
                <td>${info.speed}</td>
              </tr>
              <tr>
                <td>ضایعات</td>
                <td>${info.wastage}</td>
              </tr>
              <tr>
                <td>اولین روز تولید (شمسی)</td>
                <td>${info.first_day}</td>
              </tr>
              <tr>
                <td>آخرین روز تولید (شمسی)</td>
                <td>${info.last_day}</td>
              </tr>
              <tr>
                <td>اولین زمان ثبت (شمسی)</td>
                <td>${info.first_timestamp}</td>
              </tr>
              <tr>
                <td>آخرین زمان ثبت (شمسی)</td>
                <td>${info.last_timestamp}</td>
              </tr>
              <tr>
                <td>تعداد روزهای تولید</td>
                <td>${info.distinct_days} روز</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
      d3.select("#info-table").html(table);
    }

    function update(data) {
      const root = d3.hierarchy(data);
      root.x0 = height / 2;
      root.y0 = 0;

      root.descendants().forEach((d, i) => {
        d.id = i;
        d._children = d.children;
        if (d.depth && d.data.name !== "خط ریسندگی") d.children = null;
      });

      let i = 0;

      const duration = 750;
      const nodes = root.descendants().reverse();
      const links = root.links();

      tree(root);

      const node = g.selectAll(".node")
        .data(nodes, d => d.id || (d.id = ++i));

      const nodeEnter = node.enter().append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${root.y0},${root.x0})`)
        .on("click", (event, d) => {
          showTable(d);
        });

      nodeEnter.append("circle")
        .attr("r", 8)
        .style("fill", d => d._children ? "#20c997" : "#fff");

      nodeEnter.append("text")
        .attr("x", 12)
        .attr("dy", ".35em")
        .text(d => d.data.name);

      const nodeUpdate = node.merge(nodeEnter).transition().duration(duration)
        .attr("transform", d => `translate(${d.y},${d.x})`);

      nodeUpdate.select("circle")
        .style("fill", d => d._children ? "#20c997" : "#fff");

      nodeUpdate.select("text")
        .style("fill-opacity", 1);

      const nodeExit = node.exit().transition().duration(duration)
        .attr("transform", d => `translate(${root.y},${root.x})`)
        .remove();

      nodeExit.select("circle")
        .attr("r", 1e-6);

      nodeExit.select("text")
        .style("fill-opacity", 1e-6);

      const link = g.selectAll(".link")
        .data(links, d => d.target.id);

      const linkEnter = link.enter().append("path")
        .attr("class", "link")
        .attr("d", d => {
          const o = {x: root.x0, y: root.y0};
          return diagonal({source: o, target: o});
        });

      link.merge(linkEnter).transition().duration(duration)
        .attr("d", diagonal);

      link.exit().transition().duration(duration)
        .attr("d", d => {
          const o = {x: root.x, y: root.y};
          return diagonal({source: o, target: o});
        })
        .remove();

      nodes.forEach(d => {
        d.x0 = d.x;
        d.y0 = d.y;
      });

      function diagonal(d) {
        return `M${d.source.y},${d.source.x}
                C${(d.source.y + d.target.y) / 2},${d.source.x}
                 ${(d.source.y + d.target.y) / 2},${d.target.x}
                 ${d.target.y},${d.target.x}`;
      }
    }

    // Initial fetch
    fetchData();
  </script>
</body>
</html>